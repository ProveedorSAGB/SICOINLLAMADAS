<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Llamadas v1.0 - Firebase</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- js-xlsx para leer archivos de Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales para Firebase
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.getDoc = getDoc;
        window.addDoc = addDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.serverTimestamp = serverTimestamp;
    </script>
    
    <!-- Hoja de estilos personalizada -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .bg-gob-maroon { background-color: #6A002C; }
        .text-gob-maroon { color: #6A002C; }
        .border-gob-maroon { border-color: #6A002C; }
        .bg-subtle-green { background-color: #10B981; }
        .hover\:bg-subtle-green-dark:hover { background-color: #059669; }
        .bg-subtle-red { background-color: #EF4444; }
        .hover\:bg-subtle-red-dark:hover { background-color: #DC2626; }
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .hidden { display: none; }
        .tab-btn.active { border-color: #6A002C; color: #6A002C; font-weight: bold; }
        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #6A002C; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Estilos de tabla robustecidos */
        .table-container { overflow-x: auto; }
        .status-button {
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            font-weight: 500; /* medium */
            text-align: center;
            user-select: none;
            border: 1px solid transparent;
        }
        .status-atendida {
            background-color: #10B981; /* bg-emerald-500 */
            color: #fff;
            border-color: #059669; /* border-emerald-600 */
        }
        .status-pendiente {
            background-color: #EF4444; /* bg-red-500 */
            color: #fff;
            border-color: #DC2626; /* border-red-600 */
        }
        .sortable-header { cursor: pointer; }
        .sortable-header .sort-icon { display: none; }
        .sortable-header.asc .sort-icon.asc,
        .sortable-header.desc .sort-icon.desc { display: inline-block; }
    </style>
</head>
<body class="antialiased text-slate-700">

    <!-- Loader de Carga Inicial -->
    <div id="loader" class="loader">
        <div class="spinner"></div>
        <p class="mt-4 text-sm text-slate-600">Cargando datos, por favor espera...</p>
    </div>

    <!-- Contenedor Principal de la App -->
    <div id="app" class="min-h-screen hidden">
        <!-- Encabezado con logo y título mejorados -->
        <header class="bg-gob-maroon shadow-lg sticky top-0 z-10">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <!-- SVG del Logo del Gobierno del Estado de México (Ejemplo) -->
                    <svg class="h-14 w-auto" fill="#FFFFFF" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                    <h1 class="text-xl sm:text-2xl font-bold text-white tracking-tight">Registro de Contacto y Llamadas</h1>
                </div>
                <div id="user-info" class="text-white text-sm">
                    <!-- Aquí se mostrará el ID de usuario -->
                </div>
            </div>
        </header>

        <!-- Navegación de Pestañas -->
        <div class="bg-white shadow-sm sticky top-20 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="tabs" class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button data-tab="registro" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Registro y Control</button>
                        <button data-tab="historico" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Histórico</button>
                        <button data-tab="reportes" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Reportes y Gráficos</button>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Contenido de las Pestañas -->
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <!-- Pestaña de Registro -->
            <main id="tab-content-registro" class="tab-content">
                <!-- Dashboard, Control y Tabla -->
                <section id="dashboard" class="mb-8">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gob-maroon mb-2 sm:mb-0">Dashboard General</h2>
                        <div class="flex items-center space-x-4">
                            <label for="dashboard-data-source" class="block text-sm font-medium text-gray-700">Fuente de datos:</label>
                            <select id="dashboard-data-source" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2">
                                <option value="registro">Registro y Control</option>
                                <option value="historico">Histórico</option>
                                <option value="combinado">Registro y Control + Histórico</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                            <div class="bg-gob-maroon/10 p-3 rounded-full"><i class="fa-solid fa-phone-volume text-gob-maroon text-2xl"></i></div>
                            <div><p class="text-slate-500">Total de Llamadas</p><p id="total-calls" class="text-3xl font-bold text-gob-maroon">0</p></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                            <div class="bg-gob-maroon/10 p-3 rounded-full"><i class="fa-solid fa-hourglass-half text-gob-maroon text-2xl"></i></div>
                            <div><p class="text-slate-500">Duración Promedio</p><p id="avg-duration" class="text-3xl font-bold text-gob-maroon">00:00</p></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                            <div class="bg-subtle-green/10 p-3 rounded-full"><i class="fa-solid fa-circle-check text-subtle-green text-2xl"></i></div>
                            <div><p class="text-slate-500">Llamadas Atendidas</p><p id="atendidas-count" class="text-3xl font-bold text-subtle-green">0</p></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                            <div class="bg-subtle-red/10 p-3 rounded-full"><i class="fa-solid fa-circle-xmark text-subtle-red text-2xl"></i></div>
                            <div><p class="text-slate-500">Llamadas Pendientes</p><p id="pendientes-count" class="text-3xl font-bold text-subtle-red">0</p></div>
                        </div>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-xl shadow-md mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="text-center md:text-left">
                        <h3 class="text-xl font-semibold text-slate-800">Control de Llamadas</h3>
                        <p class="text-slate-500">Inicia una nueva llamada para activar el cronómetro y el formulario.</p>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="text-center">
                            <p class="text-sm font-medium text-slate-500">TIEMPO DE LLAMADA ACTUAL</p>
                            <p id="timer" class="text-4xl font-bold text-gob-maroon tracking-wider">00:00:00</p>
                        </div>
                        <button id="start-call-btn" class="bg-subtle-green hover:bg-subtle-green-dark text-white font-bold py-4 px-8 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out flex items-center space-x-3">
                            <i class="fa-solid fa-phone-alt h-6 w-6"></i>
                            <span>Iniciar Nueva Llamada</span>
                        </button>
                    </div>
                </section>
                
                <section id="call-log">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gob-maroon">Historial de Llamadas</h2>
                        <div class="flex items-center space-x-2">
                             <div class="relative w-full">
                                <input type="text" id="filter-input-main" placeholder="Buscar..." class="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gob-maroon">
                                <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                                <button id="clear-filter-btn-main" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden">
                                    <i class="fa-solid fa-times-circle"></i>
                                </button>
                            </div>
                            <button id="download-excel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2">
                                <i class="fa-solid fa-file-excel"></i>
                                <span>Descargar Excel</span>
                            </button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md table-container">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr id="main-table-header">
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="no">No. <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="fecha">Fecha <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="inicio">Inicio <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="fin">Fin <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="duracion">Duración <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="area">Área <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="institucion">Institución <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="asunto">Asunto <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="consulta">Consulta <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="nombre">Nombre <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="cargo">Cargo <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="correo">Correo <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="telefono">Teléfono <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="estatus">Estatus <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="atendio">Atendió <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="comentarios">Comentarios <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="calls-table-body">
                                <!-- Filas de llamadas se insertarán aquí por JavaScript -->
                            </tbody>
                        </table>
                        <div id="no-calls-message" class="p-6 text-center text-slate-500 hidden">
                            <p>No hay llamadas registradas en la base de datos.</p>
                        </div>
                    </div>
                </section>
            </main>

            <!-- Pestaña de Histórico -->
            <div id="tab-content-historico" class="tab-content hidden">
                <section class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gob-maroon mb-4">Cargar Histórico desde Excel</h2>
                    <div class="flex flex-col md:flex-row items-center gap-4">
                        <label for="historical-file-input" class="w-full md:w-auto cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 px-6 rounded-lg shadow-sm transition-all duration-200 ease-in-out text-center flex-grow">
                            <i class="fa-solid fa-file-upload mr-2"></i>
                            <span id="file-name">Seleccionar archivo Excel (.xlsx)</span>
                            <input type="file" id="historical-file-input" class="hidden" accept=".xlsx">
                        </label>
                        <button id="import-historical-btn" class="w-full md:w-auto bg-gob-maroon hover:bg-[#5a0025] text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa-solid fa-upload mr-2"></i>
                            Importar Histórico
                        </button>
                        <button id="download-historical-excel-btn" class="w-full md:w-auto bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-3 px-6 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2">
                            <i class="fa-solid fa-file-excel"></i>
                            <span>Descargar Histórico</span>
                        </button>
                    </div>
                </section>

                <section class="mt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gob-maroon">Histórico de Llamadas Cargadas</h2>
                        <div class="flex items-center space-x-2">
                             <div class="relative w-full">
                                <input type="text" id="filter-input-historico" placeholder="Buscar..." class="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gob-maroon">
                                <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                                <button id="clear-filter-btn-historico" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden">
                                    <i class="fa-solid fa-times-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md table-container">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr id="historical-table-header">
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="no">No.</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="fecha">Fecha</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="inicio">Inicio</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="fin">Fin</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="duracion">Duración</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="area">Área</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="institucion">Institución</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="asunto">Asunto</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="consulta">Consulta</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="nombre">Nombre</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="cargo">Cargo</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="correo">Correo</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="telefono">Teléfono</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="estatus">Estatus</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="atendio">Atendió</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="comentarios">Comentarios</th>
                                </tr>
                            </thead>
                            <tbody id="historical-calls-table-body">
                                <!-- Filas de llamadas históricas se insertarán aquí por JavaScript -->
                            </tbody>
                        </table>
                        <div id="no-historical-calls-message" class="p-6 text-center text-slate-500 hidden">
                            <p>No hay llamadas históricas cargadas.</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Pestaña de Reportes y Gráficos -->
            <div id="tab-content-reportes" class="tab-content hidden">
                <section class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gob-maroon mb-2 sm:mb-0">Gráficos de Llamadas</h2>
                        <div class="flex items-center space-x-4">
                            <label for="reportes-data-source" class="block text-sm font-medium text-gray-700">Fuente de datos:</label>
                            <select id="reportes-data-source" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2">
                                <option value="registro">Registro y Control</option>
                                <option value="historico">Histórico</option>
                                <option value="combinado">Registro y Control + Histórico</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-slate-100 p-4 rounded-lg shadow-inner">
                            <h3 class="text-lg font-semibold text-center mb-2">Llamadas por Mes</h3>
                            <canvas id="callsByMonthChart"></canvas>
                        </div>
                        <div class="bg-slate-100 p-4 rounded-lg shadow-inner">
                            <h3 class="text-lg font-semibold text-center mb-2">Llamadas por Estatus</h3>
                            <canvas id="callsByStatusChart"></canvas>
                        </div>
                        <div class="bg-slate-100 p-4 rounded-lg shadow-inner">
                            <h3 class="text-lg font-semibold text-center mb-2">Llamadas por Área</h3>
                            <canvas id="callsByAreaChart"></canvas>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Modal para el Formulario de Llamada -->
        <div id="call-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
            <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-11/12 md:w-2/3 lg:w-1/2">
                <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gob-maroon">Registrar Llamada</h3>
                    <button type="button" id="close-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <form id="call-form" class="mt-4 space-y-6">
                    <input type="hidden" id="call-id-field" name="id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Fecha y Hora -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Fecha y Hora de Inicio</label>
                            <input type="text" id="call-start-time" name="inicio" class="mt-1 block w-full rounded-md bg-gray-100 border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Fecha y Hora de Fin</label>
                            <input type="text" id="call-end-time" name="fin" class="mt-1 block w-full rounded-md bg-gray-100 border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" readonly>
                        </div>
                        <!-- Duración -->
                        <div>
                            <label for="call-duration" class="block text-sm font-medium text-gray-700">Duración de la llamada</label>
                            <input type="text" id="call-duration" name="duracion" class="mt-1 block w-full rounded-md bg-gray-100 border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" readonly>
                        </div>
                        <!-- Estatus -->
                        <div>
                            <label for="call-status" class="block text-sm font-medium text-gray-700">Estatus</label>
                            <select id="call-status" name="estatus" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2">
                                <option value="pendiente">Pendiente</option>
                                <option value="atendida">Atendida</option>
                            </select>
                        </div>
                        <!-- Área y Institución -->
                        <div>
                            <label for="call-area" class="block text-sm font-medium text-gray-700">Área</label>
                            <input type="text" id="call-area" name="area" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" placeholder="Área de la dependencia">
                        </div>
                        <div>
                            <label for="call-institution" class="block text-sm font-medium text-gray-700">Institución</label>
                            <div class="flex items-center space-x-2">
                                <select id="call-institution" name="institucion" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2">
                                    <option value="">Seleccione una institución</option>
                                </select>
                                <button type="button" id="add-institution-btn" class="mt-1 text-slate-500 hover:text-slate-700">
                                    <i class="fa-solid fa-plus-circle text-xl"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Asunto y Consulta -->
                        <div>
                            <label for="call-subject" class="block text-sm font-medium text-gray-700">Asunto</label>
                            <div class="flex items-center space-x-2">
                                <select id="call-subject" name="asunto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2">
                                    <option value="">Seleccione un asunto</option>
                                </select>
                                <button type="button" id="add-subject-btn" class="mt-1 text-slate-500 hover:text-slate-700">
                                    <i class="fa-solid fa-plus-circle text-xl"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label for="call-query" class="block text-sm font-medium text-gray-700">Consulta</label>
                            <input type="text" id="call-query" name="consulta" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" placeholder="Consulta específica">
                        </div>
                    </div>
                    <!-- Persona de Contacto -->
                    <div class="space-y-2 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-semibold text-gob-maroon">Datos de Contacto</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="contact-name" class="block text-sm font-medium text-gray-700">Nombre</label>
                                <input type="text" id="contact-name" name="nombre" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" placeholder="Nombre de la persona">
                            </div>
                            <div>
                                <label for="contact-position" class="block text-sm font-medium text-gray-700">Cargo</label>
                                <input type="text" id="contact-position" name="cargo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" placeholder="Cargo del contacto">
                            </div>
                            <div>
                                <label for="contact-email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                                <input type="email" id="contact-email" name="correo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" placeholder="ejemplo@dominio.com">
                            </div>
                            <div>
                                <label for="contact-phone" class="block text-sm font-medium text-gray-700">Teléfono</label>
                                <input type="tel" id="contact-phone" name="telefono" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" placeholder="Número de teléfono">
                            </div>
                        </div>
                    </div>
                    <!-- Quién atendió y Comentarios -->
                    <div class="space-y-2 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-semibold text-gob-maroon">Información Adicional</h4>
                        <div>
                            <label for="call-atendio" class="block text-sm font-medium text-gray-700">Atendió</label>
                            <div class="flex items-center space-x-2">
                                <select id="call-atendio" name="atendio" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2">
                                    <option value="">Seleccione quien atendió</option>
                                </select>
                                <button type="button" id="add-atendio-btn" class="mt-1 text-slate-500 hover:text-slate-700">
                                    <i class="fa-solid fa-plus-circle text-xl"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label for="call-comments" class="block text-sm font-medium text-gray-700">Comentarios</label>
                            <textarea id="call-comments" name="comentarios" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" placeholder="Detalles de la llamada..."></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end gap-4">
                        <button type="button" id="cancel-call-btn" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors duration-200">
                            Cancelar
                        </button>
                        <button type="submit" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gob-maroon hover:bg-[#5a0025] transition-colors duration-200">
                            Guardar Llamada
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modal de Confirmación para Importar Histórico -->
        <div id="import-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
            <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-11/12 md:w-1/3">
                <h3 class="text-xl font-bold text-gob-maroon mb-4">Confirmar Importación</h3>
                <p class="text-gray-700 mb-6">¿Estás seguro de que deseas importar este archivo de histórico? Esto reemplazará los datos actuales en la tabla de Histórico.</p>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-import-btn" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors duration-200">
                        Cancelar
                    </button>
                    <button type="button" id="confirm-import-btn" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gob-maroon hover:bg-[#5a0025] transition-colors duration-200">
                        Importar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal para Agregar Nueva Opción -->
        <div id="add-option-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
            <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-11/12 md:w-1/3">
                <h3 id="add-option-modal-title" class="text-xl font-bold text-gob-maroon mb-4">Agregar Nueva Opción</h3>
                <form id="add-option-form">
                    <label for="new-option-input" class="block text-sm font-medium text-gray-700">Nuevo valor:</label>
                    <input type="text" id="new-option-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" required>
                    <div class="mt-6 flex justify-end gap-4">
                        <button type="button" id="cancel-add-option-btn" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors duration-200">
                            Cancelar
                        </button>
                        <button type="submit" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gob-maroon hover:bg-[#5a0025] transition-colors duration-200">
                            Agregar
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <!-- Scripts de la aplicación -->
    <script type="module">
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


// ====================================================================================================
//                                     VARIABLES GLOBALES
// ====================================================================================================
        
        let timerInterval;
        let startTime;
        let firestoreDb, firebaseAuth;
        let userId = 'anon_user';
        let calls = [];
        let historicalCalls = [];
        let callsByMonthChart, callsByStatusChart, callsByAreaChart;
        let currentSortColumn = 'no';
        let currentSortDirection = 'asc';
        let historicalSortColumn = 'no';
        let historicalSortDirection = 'asc';
        let isEditing = false;
        let editingCallId = null;
        let targetSelectForNewOption = null;

// ====================================================================================================
//                                     CONSTANTES Y ELEMENTOS DEL DOM
// ====================================================================================================

        const callModal = document.getElementById('call-modal');
        const importModal = document.getElementById('import-modal');
        const addOptionModal = document.getElementById('add-option-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const startCallBtn = document.getElementById('start-call-btn');
        const cancelCallBtn = document.getElementById('cancel-call-btn');
        const callForm = document.getElementById('call-form');
        const callIdField = document.getElementById('call-id-field');
        const timerDisplay = document.getElementById('timer');
        const callsTableBody = document.getElementById('calls-table-body');
        const noCallsMessage = document.getElementById('no-calls-message');
        const historicalCallsTableBody = document.getElementById('historical-calls-table-body');
        const noHistoricalCallsMessage = document.getElementById('no-historical-calls-message');
        const downloadExcelBtn = document.getElementById('download-excel-btn');
        const downloadHistoricalExcelBtn = document.getElementById('download-historical-excel-btn');
        const historicalFileInput = document.getElementById('historical-file-input');
        const importHistoricalBtn = document.getElementById('import-historical-btn');
        const fileNameSpan = document.getElementById('file-name');
        const loaderDiv = document.getElementById('loader');
        const appDiv = document.getElementById('app');
        const tabs = document.getElementById('tabs');
        const dashboardDataSource = document.getElementById('dashboard-data-source');
        const reportesDataSource = document.getElementById('reportes-data-source');
        const filterInputMain = document.getElementById('filter-input-main');
        const clearFilterBtnMain = document.getElementById('clear-filter-btn-main');
        const filterInputHistorico = document.getElementById('filter-input-historico');
        const clearFilterBtnHistorico = document.getElementById('clear-filter-btn-historico');
        const mainTableHeader = document.getElementById('main-table-header');
        const historicalTableHeader = document.getElementById('historical-table-header');
        const userInfoDiv = document.getElementById('user-info');
        
        // Form selects
        const callInstitutionSelect = document.getElementById('call-institution');
        const callSubjectSelect = document.getElementById('call-subject');
        const callAtendioSelect = document.getElementById('call-atendio');
        const addInstitutionBtn = document.getElementById('add-institution-btn');
        const addSubjectBtn = document.getElementById('add-subject-btn');
        const addAtendioBtn = document.getElementById('add-atendio-btn');
        const addOptionForm = document.getElementById('add-option-form');
        const newOptionInput = document.getElementById('new-option-input');

        // Modal de confirmación para importación
        const cancelImportBtn = document.getElementById('cancel-import-btn');
        const confirmImportBtn = document.getElementById('confirm-import-btn');
        const cancelAddOptionBtn = document.getElementById('cancel-add-option-btn');

// ====================================================================================================
//                                     CONFIGURACIÓN DE FIREBASE CREDENCIALES
// ====================================================================================================

        // ¡Asegúrate de que tus credenciales estén aquí!
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Inicializar Firebase
        let app;
        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                firestoreDb = getFirestore(app);
                firebaseAuth = getAuth(app);
            } else {
                console.error("Firebase config is missing. Cannot initialize Firebase.");
            }
        } catch (e) {
            console.error("Error initializing Firebase:", e);
        }


// ====================================================================================================
//                                     CONFIGURACIÓN DE FIREBASE - AUTHENTICACION
// ====================================================================================================

        async function authenticateUser() {
            try {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(firebaseAuth, initialAuthToken);
                } else {
                    await signInAnonymously(firebaseAuth);
                }
            } catch (error) {
                console.error("Error during authentication:", error);
            }
        }
        
        // Listener de estado de autenticación
        if (firebaseAuth) {
            onAuthStateChanged(firebaseAuth, (user) => {
                if (user) {
                    userId = user.uid;
                    userInfoDiv.textContent = `ID de Usuario: ${userId}`;
                    console.log("User authenticated with ID:", userId);
                    // Ocultar el loader y mostrar la app una vez que la autenticación está lista
                    hideLoader();
                    document.getElementById('app').classList.remove('hidden');
                    // Iniciar la escucha de datos
                    setupFirestoreListeners();
                } else {
                    userId = null;
                    userInfoDiv.textContent = 'Usuario Anónimo';
                    console.log("User is signed out or anonymous.");
                    // Si no hay usuario, mostrar la app de todos modos, pero sin datos de Firestore
                    hideLoader();
                    document.getElementById('app').classList.remove('hidden');
                }
            });
        }



        // Función para configurar los listeners de Firestore
        function setupFirestoreListeners() {
            if (!firestoreDb || !userId) {
                console.warn("Firestore or User ID not available. Cannot set up listeners.");
                return;
            }

            // Colección para llamadas del usuario actual
            const callsCollection = collection(firestoreDb, `artifacts/${appId}/users/${userId}/calls`);
            const callsQuery = query(callsCollection);

            // Listener en tiempo real para las llamadas del usuario
            onSnapshot(callsQuery, (snapshot) => {
                const fetchedCalls = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Asegurar que las fechas se almacenan y se muestran en el formato correcto
                    const inicioDate = data.inicio instanceof Date ? data.inicio.toLocaleString() : data.inicio;
                    const finDate = data.fin instanceof Date ? data.fin.toLocaleString() : data.fin;
                    const fechaDate = data.fecha instanceof Date ? data.fecha.toLocaleDateString() : data.fecha;
                    fetchedCalls.push({ 
                        id: doc.id,
                        ...data,
                        inicio: inicioDate,
                        fin: finDate,
                        fecha: fechaDate
                    });
                });
                calls = fetchedCalls;
                updateDashboard(calls, historicalCalls);
                renderTable(calls, callsTableBody, "main");
                populateDropdowns(calls, historicalCalls);
            }, (error) => {
                console.error("Error fetching real-time calls:", error);
                loadInitialData();
            });


            // Función para cargar los datos iniciales si el listener en tiempo real falla
            async function loadInitialData() {
                try {
                    const snapshot = await getDocs(callsQuery);
                    const fetchedCalls = [];
                    snapshot.forEach((doc) => {
                         const data = doc.data();
                         const inicioDate = data.inicio instanceof Date ? data.inicio.toLocaleString() : data.inicio;
                         const finDate = data.fin instanceof Date ? data.fin.toLocaleString() : data.fin;
                         const fechaDate = data.fecha instanceof Date ? data.fecha.toLocaleDateString() : data.fecha;
                         fetchedCalls.push({ 
                            id: doc.id,
                            ...data,
                            inicio: inicioDate,
                            fin: finDate,
                            fecha: fechaDate
                        });
                    });
                    calls = fetchedCalls;
                    updateDashboard(calls, historicalCalls);
                    renderTable(calls, callsTableBody, "main");
                    populateDropdowns(calls, historicalCalls);
                } catch (error) {
                    console.error("Error fetching initial calls data:", error);
                }
            }
        }




// ====================================================================================================
//                                     GUARDAR NUEVA LLAMADA - FIRESTORE
// ====================================================================================================

        async function saveCallToFirestore(callData) {
            if (!firestoreDb || !userId) {
                console.error("Firestore or User ID not available. Cannot save data.");
                return;
            }
            try {
                const callsCollection = collection(firestoreDb, `artifacts/${appId}/users/${userId}/calls`);
                if (callData.id) {
                    const callRef = doc(callsCollection, callData.id);
                    await setDoc(callRef, { ...callData, timestamp: serverTimestamp() }, { merge: true });
                    console.log("Llamada actualizada en Firestore.");
                } else {
                    const dataWithTimestamp = { ...callData, timestamp: serverTimestamp() };
                    await addDoc(callsCollection, dataWithTimestamp);
                    console.log("Llamada guardada en Firestore.");
                }
            } catch (error) {
                console.error("Error al guardar la llamada en Firestore:", error);
            }
        }


        // Lógica del cronómetro
        function startTimer() {
            startTime = new Date();
            timerInterval = setInterval(() => {
                const now = new Date();
                const durationInSeconds = Math.floor((now - startTime) / 1000);
                timerDisplay.textContent = formatTime(durationInSeconds);
            }, 1000);
        }


        // Detener cronometro
        function stopTimer() {
            clearInterval(timerInterval);
        }
        
        // Resetear cronómetro
        function resetTimer() {
            stopTimer();
            timerDisplay.textContent = '00:00:00';
            startTime = null;
        }




// ====================================================================================================
//                                     FUNCIONES PARA FORMATO DE FECHAS
// ====================================================================================================


        // Funciones de utilidad
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return [hours, minutes, seconds].map(v => String(v).padStart(2, '0')).join(':');
        }

        // Funciones para convertir las fechas de Excel a formato JavaScript
        function excelDateToJSDate(serial) {
            const date = new Date(Math.round((serial - 25569) * 86400 * 1000) + 86400 * 1000); // sumar 1 día
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Función para convertir la hora de Excel a un formato de hora legible (ej. 10:20:26 a. m.)
        function excelTimeToJSString(serial) {
            const totalSeconds = Math.floor(serial * 86400);
            let hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const ampm = hours >= 12 ? 'p. m.' : 'a. m.';
            hours = hours % 12;
            if (hours === 0) hours = 12; // caso medianoche / mediodía

            const hh = String(hours).padStart(2, '0');
            const mm = String(minutes).padStart(2, '0');
            const ss = String(seconds).padStart(2, '0');

            return `${hh}:${mm}:${ss} ${ampm}`;
        }

        // Función para obtener la duración de la llamada en el historico, presentando hh:mm:ss
        function excelDuracionToJSString(serial) {
            const totalSeconds = Math.floor(serial * 86400);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const hh = String(hours).padStart(2, '0');
            const mm = String(minutes).padStart(2, '0');
            const ss = String(seconds).padStart(2, '0');

            return `${hh}:${mm}:${ss}`;
        }



// ====================================================================================================
//                                  MOSTRAR MODAL DEL FORMULARIO - nueva LLAMADA
// ====================================================================================================


        // Mostrar modal
        function showModal(modal, callData = null) {
            // Solo ejecutar la lógica de nueva llamada para el modal principal
            if (modal === callModal) {
                isEditing = callData !== null;
                if (isEditing) {
                    fillFormForEdit(callData);
                } else {
                    resetForm();
                    document.getElementById('call-start-time').value = new Date().toLocaleString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(',', '');
                    startTimer();
                }
            }
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
        }
        
        function hideModal(modal) {
            modal.classList.add('modal-leave');
            modal.classList.remove('modal-enter');
            modal.addEventListener('animationend', () => modal.classList.add('hidden'), { once: true });

            // Solo ejecutar la lógica específica de la llamada para el modal principal
            if (modal === callModal) {
                if (!isEditing) resetTimer();
                editingCallId = null;
                isEditing = false;
            }
        }



        // Resetar Formulario

        function resetForm() {
            callForm.reset();
            callIdField.value = '';
            document.getElementById('call-institution').innerHTML = '<option value="">Seleccione una institución</option>';
            document.getElementById('call-subject').innerHTML = '<option value="">Seleccione un asunto</option>';
            document.getElementById('call-atendio').innerHTML = '<option value="">Seleccione quien atendió</option>';
            populateDropdowns(calls, historicalCalls);
        }

// ====================================================================================================
//                                 EDITAR FORMULARIO
// ====================================================================================================

        function fillFormForEdit(callData) {
            callIdField.value = callData.id;
            document.getElementById('call-start-time').value = callData.inicio;
            document.getElementById('call-end-time').value = callData.fin;
            document.getElementById('call-duration').value = callData.duracion;
            document.getElementById('call-status').value = callData.estatus;
            document.getElementById('call-area').value = callData.area;
            document.getElementById('call-query').value = callData.consulta;
            document.getElementById('contact-name').value = callData.nombre;
            document.getElementById('contact-position').value = callData.cargo;
            document.getElementById('contact-email').value = callData.correo;
            document.getElementById('contact-phone').value = callData.telefono;
            document.getElementById('call-comments').value = callData.comentarios;
            
            // Llenar selects
            populateDropdowns(calls, historicalCalls);
            // Seleccionar los valores correctos
            document.getElementById('call-institution').value = callData.institucion || '';
            document.getElementById('call-subject').value = callData.asunto || '';
            document.getElementById('call-atendio').value = callData.atendio || '';

            // Desactivar el cronómetro para la edición
            stopTimer();
            timerDisplay.textContent = callData.duracion;
        }


// ====================================================================================================
//                                EXPORTAR HISTORIAL DE LLAMADAS A EXCEL
// ====================================================================================================



        function hideLoader() {
            loaderDiv.classList.add('hidden');
        }
        
        function exportToExcel(data, fileName) {
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Llamadas");
            XLSX.writeFile(workbook, `${fileName}_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }
        

// ====================================================================================================
//                                  FUNCIONES DEL DASHBOARD
// ====================================================================================================

        // --- Funciones del Dashboard ---
        function updateDashboard(currentData, historicalData) {
            const dataSource = dashboardDataSource.value;
            let combinedData = [];
        
            if (dataSource === 'registro') {
                combinedData = currentData;
            } else if (dataSource === 'historico') {
                combinedData = historicalData;
            } else { // combinado
                combinedData = [...currentData, ...historicalData];
            }

            const totalCalls = combinedData.length;
            const atendidas = combinedData.filter(call => call.estatus === 'atendida').length;
            const pendientes = combinedData.filter(call => call.estatus === 'pendiente').length;

            let totalDurationInSeconds = 0;
            combinedData.forEach(call => {
                if (call.duracion) {
                    const parts = call.duracion.split(':').map(Number);
                    if (parts.length === 3) {
                        totalDurationInSeconds += parts[0] * 3600 + parts[1] * 60 + parts[2];
                    }
                }
            });

            const avgDuration = totalCalls > 0 ? totalDurationInSeconds / totalCalls : 0;

            document.getElementById('total-calls').textContent = totalCalls;
            document.getElementById('atendidas-count').textContent = atendidas;
            document.getElementById('pendientes-count').textContent = pendientes;
            document.getElementById('avg-duration').textContent = formatTime(Math.round(avgDuration));
            
            // Actualizar gráficos
            const reportesDataSourceValue = reportesDataSource.value;
            let reportData = [];
            if (reportesDataSourceValue === 'registro') {
                reportData = calls;
            } else if (reportesDataSourceValue === 'historico') {
                reportData = historicalCalls;
            } else { // combinado
                reportData = [...calls, ...historicalCalls];
            }
            updateCharts(reportData);
        }
        





        function populateDropdowns(currentData, historicalData) {
            const combinedData = [...currentData, ...historicalData];

            const institutions = [...new Set(combinedData.map(call => call.institucion).filter(Boolean))].sort();
            const subjects = [...new Set(combinedData.map(call => call.asunto).filter(Boolean))].sort();
            const atendio = [...new Set(combinedData.map(call => call.atendio).filter(Boolean))].sort();

            function populateSelect(selectElement, options, currentValue) {
                const selectedValue = selectElement.value;
                const placeholder = selectElement.querySelector('option[value=""]').textContent;
                selectElement.innerHTML = `<option value="">${placeholder}</option>`;
                options.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    selectElement.appendChild(opt);
                });
                selectElement.value = currentValue || selectedValue;
            }

            populateSelect(callInstitutionSelect, institutions, callInstitutionSelect.value);
            populateSelect(callSubjectSelect, subjects, callSubjectSelect.value);
            populateSelect(callAtendioSelect, atendio, callAtendioSelect.value);
        }


// ====================================================================================================
//                                  RENDERIZADO DE TABLAS Y GRÁFICAS
// ====================================================================================================

        // Lógica de Renderizado de Tablas y Gráficos
        function renderTable(data, tableBody, tableType) {
            // Determinar la columna y dirección de ordenamiento
            const sortBy = tableType === 'main' ? currentSortColumn : historicalSortColumn;
            const sortDirection = tableType === 'main' ? currentSortDirection : historicalSortDirection;

            // Ordenar los datos
            const sortedData = [...data].sort((a, b) => {
                let valA = a[sortBy];
                let valB = b[sortBy];

                // Convertir a minúsculas para ordenar strings sin distinción de mayúsculas y minúsculas
                if (typeof valA === 'string' && typeof valB === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            tableBody.innerHTML = '';
            if (sortedData.length === 0) {
                const noMessage = tableType === 'main' ? noCallsMessage : noHistoricalCallsMessage;
                noMessage.classList.remove('hidden');
                return;
            }
            const noMessage = tableType === 'main' ? noCallsMessage : noHistoricalCallsMessage;
            noMessage.classList.add('hidden');

            sortedData.forEach((call, index) => {
                const row = document.createElement('tr');
                row.classList.add('bg-white', 'border-b', 'hover:bg-slate-50', 'transition-colors', 'duration-150');
                
                // Los datos ya están formateados en el objeto call
                const fields = [
                    index + 1, // No.
                    call.fecha,
                    call.inicio,
                    call.fin,
                    call.duracion,
                    call.area,
                    call.institucion,
                    call.asunto,
                    call.consulta,
                    call.nombre,
                    call.cargo,
                    call.correo,
                    call.telefono,
                    call.estatus,
                    call.atendio,
                    call.comentarios
                ];
                
                fields.forEach((field, fieldIndex) => {
                    const cell = document.createElement('td');
                    cell.classList.add('py-4', 'px-6', 'whitespace-nowrap');
                    cell.textContent = field || '';
                    if (fieldIndex === 13) { // Columna de estatus
                        cell.innerHTML = `
                            <button class="status-button ${field === 'atendida' ? 'status-atendida' : 'status-pendiente'}">
                                ${field === 'atendida' ? 'Atendida' : 'Pendiente'}
                            </button>
                        `;
                        cell.querySelector('.status-button').addEventListener('click', async (e) => {
                            e.stopPropagation(); // Evita que se dispare el evento del modal
                            if (tableType === 'main' && firestoreDb && userId) {
                                const newStatus = call.estatus === 'atendida' ? 'pendiente' : 'atendida';
                                try {
                                    const callRef = doc(firestoreDb, `artifacts/${appId}/users/${userId}/calls`, call.id);
                                    await setDoc(callRef, { estatus: newStatus }, { merge: true });
                                    console.log("Estatus de llamada actualizado.");
                                } catch (error) {
                                    console.error("Error al actualizar el estatus:", error);
                                }
                            }
                        });
                    }
                    row.appendChild(cell);
                });

                if (tableType === 'main') { // Columna de acciones
                    const actionsCell = document.createElement('td');
                    actionsCell.classList.add('py-4', 'px-6', 'whitespace-nowrap', 'space-x-2');
                    actionsCell.innerHTML = `
                        <button class="text-blue-500 hover:text-blue-700 transition-colors duration-200 edit-call" data-id="${call.id}">
                            <i class="fa-solid fa-edit"></i>
                        </button>
                        <button class="text-gob-maroon hover:text-red-700 transition-colors duration-200 delete-call" data-id="${call.id}">
                            <i class="fa-solid fa-trash-alt"></i>
                        </button>
                    `;
                    actionsCell.querySelector('.edit-call').addEventListener('click', () => {
                        showModal(callModal, call);
                    });
                    actionsCell.querySelector('.delete-call').addEventListener('click', async () => {
                        // Lógica para eliminar de Firestore
                        try {
                            const callRef = doc(firestoreDb, `artifacts/${appId}/users/${userId}/calls`, call.id);
                            await deleteDoc(callRef);
                            console.log("Llamada eliminada de Firestore.");
                        } catch (error) {
                            console.error("Error al eliminar la llamada:", error);
                        }
                    });
                    row.appendChild(actionsCell);
                }
                
                tableBody.appendChild(row);
            });
        }


// ====================================================================================================
//                                  FUNCION PARA ORDENAR TABLA DATOS
// ====================================================================================================

        function setupSorting(headerElement, tableType) {
            const headers = headerElement.querySelectorAll('.sortable-header');
            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const sortBy = header.getAttribute('data-sort-by');
                    let sortDirection;
                    if (tableType === 'main') {
                        if (currentSortColumn === sortBy) {
                            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            currentSortColumn = sortBy;
                            currentSortDirection = 'asc';
                        }
                        renderTable(calls, callsTableBody, 'main');
                        
                        headers.forEach(h => h.classList.remove('asc', 'desc'));
                        header.classList.add(currentSortDirection);
                    } else {
                        if (historicalSortColumn === sortBy) {
                            historicalSortDirection = historicalSortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            historicalSortColumn = sortBy;
                            historicalSortDirection = 'asc';
                        }
                        renderTable(historicalCalls, historicalCallsTableBody, 'historico');
                        
                        headers.forEach(h => h.classList.remove('asc', 'desc'));
                        header.classList.add(historicalSortDirection);
                    }
                });
            });
        }

        //Funcion para actualizar Grafico de llamadas por mes
        function updateCharts(data) {
            const callsByMonth = {};
            const callsByStatus = { atendida: 0, pendiente: 0 };
            const callsByArea = {};
            const months = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];

            data.forEach(call => {
                // Gráfico de llamadas por mes
                // Asumiendo que `call.fecha` tiene el formato 'dd/mm/yyyy'
                if (call.fecha && call.fecha.includes('/')) {
                    const [day, month, year] = call.fecha.split('/');
                    const date = new Date(year, month - 1, day);
                    const monthName = months[date.getMonth()];
                    callsByMonth[monthName] = (callsByMonth[monthName] || 0) + 1;
                }

                // Gráfico de llamadas por estatus
                if (call.estatus === 'atendida') {
                    callsByStatus.atendida++;
                } else if (call.estatus === 'pendiente') {
                    callsByStatus.pendiente++;
                }

                // Gráfico de llamadas por área
                if (call.area) {
                    callsByArea[call.area] = (callsByArea[call.area] || 0) + 1;
                }
            });

            const callsByMonthData = {
                labels: months,
                datasets: [{
                    label: 'Llamadas por Mes',
                    data: months.map(m => callsByMonth[m] || 0),
                    backgroundColor: '#6A002C',
                    borderColor: '#6A002C',
                    borderWidth: 1,
                }],
            };

            const callsByStatusData = {
                labels: ['Atendidas', 'Pendientes'],
                datasets: [{
                    label: 'Llamadas por Estatus',
                    data: [callsByStatus.atendida, callsByStatus.pendiente],
                    backgroundColor: ['#10B981', '#EF4444'],
                    hoverOffset: 4,
                }],
            };

            const callsByAreaData = {
                labels: Object.keys(callsByArea),
                datasets: [{
                    label: 'Llamadas por Área',
                    data: Object.values(callsByArea),
                    backgroundColor: '#1C3D5A', // Color para este gráfico
                    hoverOffset: 4,
                }]
            };

            const callsByMonthCtx = document.getElementById('callsByMonthChart').getContext('2d');
            const callsByStatusCtx = document.getElementById('callsByStatusChart').getContext('2d');
            const callsByAreaCtx = document.getElementById('callsByAreaChart').getContext('2d');

            if (callsByMonthChart) { callsByMonthChart.destroy(); }
            if (callsByStatusChart) { callsByStatusChart.destroy(); }
            if (callsByAreaChart) { callsByAreaChart.destroy(); }
            
            callsByMonthChart = new Chart(callsByMonthCtx, {
                type: 'bar',
                data: callsByMonthData,
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
            
            callsByStatusChart = new Chart(callsByStatusCtx, {
                type: 'doughnut',
                data: callsByStatusData,
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } }
                }
            });

            callsByAreaChart = new Chart(callsByAreaCtx, {
                type: 'doughnut',
                data: callsByAreaData,
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } }
                }
            });
        }



// ====================================================================================================
//                                  MANEJO DE EVENTOS
// ====================================================================================================

        // Manejo de eventos
        document.addEventListener('DOMContentLoaded', async () => {
            await authenticateUser();
            
            // Lógica de pestañas
            tabs.addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(`tab-content-${e.target.dataset.tab}`).classList.remove('hidden');
                }
            });

            // Lógica del modal
            startCallBtn.addEventListener('click', () => {
                showModal(callModal);
            });
            
            closeModalBtn.addEventListener('click', () => {
                hideModal(callModal);
            });

            cancelCallBtn.addEventListener('click', () => {
                hideModal(callModal);
            });
            
            // Envío del formulario
            callForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const id = callIdField.value;
                let callData;

                if (id) { // Editando llamada existente
                    callData = {
                        id: id,
                        fecha: document.getElementById('call-start-time').value.split(',')[0].trim(),
                        inicio: document.getElementById('call-start-time').value,
                        fin: document.getElementById('call-end-time').value,
                        duracion: document.getElementById('call-duration').value,
                        area: document.getElementById('call-area').value,
                        institucion: document.getElementById('call-institution').value,
                        asunto: document.getElementById('call-subject').value,
                        consulta: document.getElementById('call-query').value,
                        nombre: document.getElementById('contact-name').value,
                        cargo: document.getElementById('contact-position').value,
                        correo: document.getElementById('contact-email').value,
                        telefono: document.getElementById('contact-phone').value,
                        estatus: document.getElementById('call-status').value,
                        atendio: document.getElementById('call-atendio').value,
                        comentarios: document.getElementById('call-comments').value,
                    };
                } else { // Nueva llamada
                    stopTimer();
                    const now = new Date();
                    const durationInSeconds = Math.floor((now - startTime) / 1000);
                    const formattedDuration = formatTime(durationInSeconds);
                    const formattedStartTime = startTime.toLocaleString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(',', '');
                    const formattedEndTime = now.toLocaleString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(',', '');
                    
                    document.getElementById('call-end-time').value = formattedEndTime;
                    document.getElementById('call-duration').value = formattedDuration;

                    callData = {
                        fecha: formattedStartTime.split(',')[0].trim(),
                        inicio: formattedStartTime,
                        fin: formattedEndTime,
                        duracion: formattedDuration,
                        area: document.getElementById('call-area').value,
                        institucion: document.getElementById('call-institution').value,
                        asunto: document.getElementById('call-subject').value,
                        consulta: document.getElementById('call-query').value,
                        nombre: document.getElementById('contact-name').value,
                        cargo: document.getElementById('contact-position').value,
                        correo: document.getElementById('contact-email').value,
                        telefono: document.getElementById('contact-phone').value,
                        estatus: document.getElementById('call-status').value,
                        atendio: document.getElementById('call-atendio').value,
                        comentarios: document.getElementById('call-comments').value,
                    };
                }

                await saveCallToFirestore(callData);
                
                resetForm();
                hideModal(callModal);
            });
            
            // Botón de descargar Excel
            downloadExcelBtn.addEventListener('click', () => {
                const dataToExport = calls.map(({ id, ...rest }) => rest); // Excluir el ID de Firebase
                if (dataToExport.length > 0) {
                    exportToExcel(dataToExport, "Registro de Llamadas");
                }
            });
            
            downloadHistoricalExcelBtn.addEventListener('click', () => {
                const dataToExport = historicalCalls;
                if (dataToExport.length > 0) {
                    exportToExcel(dataToExport, "Historico de Llamadas");
                }
            });



// ====================================================================================================
//                                  IMPORTACIÓN DE HISTORICO DE EXCEL
// ====================================================================================================

            // Lógica de importación de histórico desde Excel
            historicalFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    fileNameSpan.textContent = file.name;
                    importHistoricalBtn.disabled = false;
                } else {
                    fileNameSpan.textContent = 'Seleccionar archivo Excel (.xlsx)';
                    importHistoricalBtn.disabled = true;
                }
            });

            importHistoricalBtn.addEventListener('click', () => {
                const file = historicalFileInput.files[0];
                if (!file) return;
                showModal(importModal);
            });
            
            confirmImportBtn.addEventListener('click', () => {
                hideModal(importModal);
                const file = historicalFileInput.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        historicalCalls = jsonData.map(row => {
                            // Mapear y procesar los datos con las funciones de Excel
                            const processedRow = {};
                            for (const key in row) {
                                const normalizedKey = key.toLowerCase().replace(/á/g, 'a').replace(/ó/g, 'o').replace(/ú/g, 'u').replace(/ñ/g, 'n').replace(/\s+/g, '');
                                processedRow[normalizedKey] = row[key];
                            }
                            
                            const callData = {
                                fecha: processedRow.fecha ? excelDateToJSDate(processedRow.fecha) : '',
                                inicio: processedRow.inicio ? excelTimeToJSString(processedRow.inicio) : '',
                                fin: processedRow.fin ? excelTimeToJSString(processedRow.fin) : '',
                                duracion: processedRow.duracion ? excelDuracionToJSString(processedRow.duracion) : '',
                                area: processedRow.area || '',
                                institucion: processedRow.institucion || '',
                                asunto: processedRow.asunto || '',
                                consulta: processedRow.consulta || '',
                                nombre: processedRow.nombre || '',
                                cargo: processedRow.cargo || '',
                                correo: processedRow.correo || '',
                                telefono: processedRow.telefono || '',
                                estatus: (processedRow.estatus || '').toLowerCase() === 'atendida' ? 'atendida' : 'pendiente',
                                atendio: processedRow.atendio || '',
                                comentarios: processedRow.comentarios || '',
                            };
                            
                            // Solo hora, sin concatenar fecha
                            if (processedRow.inicio) {
                                callData.inicio = excelTimeToJSString(processedRow.inicio);
                            }
                            if (processedRow.fin) {
                                callData.fin = excelTimeToJSString(processedRow.fin);
                            }
                            
                            return callData;
                        });
                        
                        renderTable(historicalCalls, historicalCallsTableBody, "historico");
                        updateDashboard(calls, historicalCalls);
                        populateDropdowns(calls, historicalCalls);
                    } catch (error) {
                        console.error("Error al procesar el archivo de Excel:", error);
                        // Implementar un modal de error si es necesario
                    }
                };
                reader.readAsArrayBuffer(file);
            });
            
            cancelImportBtn.addEventListener('click', () => {
                hideModal(importModal);
            });


// ====================================================================================================
//                                  AGREGAR OPCIONES A LOS SELECTS
// ====================================================================================================


            // Lógica de agregar opciones a los selects
            function setupAddOptionButton(button, selectElement, modalTitle) {
                button.addEventListener('click', () => {
                    targetSelectForNewOption = selectElement;
                    document.getElementById('add-option-modal-title').textContent = modalTitle;
                    newOptionInput.value = ''; // Limpiar valor previo
                    showModal(addOptionModal);
                });
            }

            setupAddOptionButton(addInstitutionBtn, callInstitutionSelect, 'Agregar Nueva Institución');
            setupAddOptionButton(addSubjectBtn, callSubjectSelect, 'Agregar Nuevo Asunto');
            setupAddOptionButton(addAtendioBtn, callAtendioSelect, 'Agregar Nuevo Responsable');

            cancelAddOptionBtn.addEventListener('click', () => {
                hideModal(addOptionModal);
            });

            addOptionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newOptionValue = newOptionInput.value.trim();
                if (newOptionValue && targetSelectForNewOption) {
                    const option = document.createElement('option');
                    option.value = newOptionValue;
                    option.textContent = newOptionValue;
                    targetSelectForNewOption.appendChild(option);
                    targetSelectForNewOption.value = newOptionValue;
                    hideModal(addOptionModal);
                }
            });

            // Lógica de filtrado de tablas
            function setupFilter(inputElement, clearBtnElement, tableType) {
                inputElement.addEventListener('keyup', (e) => {
                    const filterValue = e.target.value.toLowerCase();
                    const data = tableType === 'main' ? calls : historicalCalls;
                    const filteredData = data.filter(call => 
                        Object.values(call).some(val => 
                            String(val).toLowerCase().includes(filterValue)
                        )
                    );
                    const tableBody = tableType === 'main' ? callsTableBody : historicalCallsTableBody;
                    renderTable(filteredData, tableBody, tableType);

                    if (filterValue.length > 0) {
                        clearBtnElement.classList.remove('hidden');
                    } else {
                        clearBtnElement.classList.add('hidden');
                    }
                });

                clearBtnElement.addEventListener('click', () => {
                    inputElement.value = '';
                    clearBtnElement.classList.add('hidden');
                    const data = tableType === 'main' ? calls : historicalCalls;
                    const tableBody = tableType === 'main' ? callsTableBody : historicalCallsTableBody;
                    renderTable(data, tableBody, tableType);
                });
            }

            setupFilter(filterInputMain, clearFilterBtnMain, 'main');
            setupFilter(filterInputHistorico, clearFilterBtnHistorico, 'historico');

            // Lógica de ordenamiento
            setupSorting(mainTableHeader, 'main');
            setupSorting(historicalTableHeader, 'historico');
            
            // Lógica para actualizar el dashboard al cambiar la fuente de datos VERSIONNNNNNNNNNNNNNNNN
            dashboardDataSource.addEventListener('change', () => {
                updateDashboard(calls, historicalCalls);
            });
            
            reportesDataSource.addEventListener('change', () => {
                const dataSource = reportesDataSource.value;
                let reportData = [];
                if (dataSource === 'registro') {
                    reportData = calls;
                } else if (dataSource === 'historico') {
                    reportData = historicalCalls;
                } else { // combinado
                    reportData = [...calls, ...historicalCalls];
                }
                updateCharts(reportData);
            });
            
            if (typeof __initial_auth_token === 'undefined' && typeof __firebase_config === 'undefined') {
                // Si las variables de entorno no están presentes (por ejemplo, en un entorno de desarrollo local),
                // ocultamos el loader y mostramos la app directamente, sin autenticación de Firebase.
                // Esto permite que la app siga siendo funcional para tareas sin persistencia.
                console.warn("Firebase environment variables not found. Running in a non-persistent mode.");
                hideLoader();
                document.getElementById('app').classList.remove('hidden');
            }
        });

    </script>
</body>
</html>
