<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Llamadas v1.3</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- js-xlsx para leer archivos de Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- PivotTable.js para tabla dinámica interactiva -->
    <link rel="stylesheet" type="text/css" href="https://pivottable.js.org/dist/pivot.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://pivottable.js.org/dist/pivot.min.js"></script>
    
    <!-- Select2 for searchable dropdown -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- html2pdf para generar reportes en PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Hoja de estilos personalizada -->
    <style>
        html { font-size: 55%; } /* Simula zoom negativo al 75% */
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        
        /* Nueva paleta de colores */
        .bg-primary { background-color: #9C2348; }
        .text-primary { color: #9C2348; }
        .border-primary { border-color: #9C2348; }
        .focus\:ring-primary:focus { --tw-ring-color: #9C2348; }
        
        .bg-secondary { background-color: #A6802D; }
        .text-secondary { color: #A6802D; }
        .border-secondary { border-color: #A6802D; }
        
        .bg-accent { background-color: #1E5B4F; }
        .text-accent { color: #1E5B4F; }
        .border-accent { border-color: #1E5B4F; }
        
        .bg-success { background-color: #10B981; }
        .hover\:bg-success-dark:hover { background-color: #059669; }
        
        .bg-danger { background-color: #EF4444; }
        .hover\:bg-danger-dark:hover { background-color: #DC2626; }
        
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        
        .hidden { display: none; }
        .tab-btn.active { border-color: #9C2348; color: #9C2348; font-weight: bold; }
        
        .loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(255, 255, 255, 0.9); z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        .loader .spinner { 
            border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; 
            border-left-color: #9C2348; animation: spin 1s ease infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .table-container { 
            overflow-x: auto; 
            max-height: 500px; /* Altura máxima para scroll vertical */
            overflow-y: auto;
        }
        
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .status-button {
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem;
            line-height: 1.25rem; font-weight: 500; text-align: center; user-select: none; border: 1px solid transparent;
        }
        .status-atendida { background-color: #10B981; color: #fff; border-color: #059669; }
        .status-pendiente { background-color: #EF4444; color: #fff; border-color: #DC2626; }
        
        .sortable-header { cursor: pointer; }
        .sortable-header .sort-icon { display: none; }
        .sortable-header.asc .sort-icon.asc,
        .sortable-header.desc .sort-icon.desc { display: inline-block; }
        
        input:invalid, select:invalid { border-color: #ef4444; }
        
        .section-title { font-weight: bold; color: #9C2348; margin-bottom: 1rem; }
        header + div { top: 56px !important; } /* Ajuste para eliminar hueco entre header y tabs */

        /* Aumentar el ancho máximo del contenedor principal */
        .max-w-7xl {
            max-width: 100% !important;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        /* Ajustar el ancho de las tablas */
        .table-container table {
            width: 100%;
            min-width: 1200px; /* Ancho mínimo aumentado */
        }

        /* Asegurar que el contenedor de la tabla ocupe todo el ancho */
        .table-container {
            width: 100%;
            overflow-x: auto;
        }

        /* Ajustar el ancho de las columnas específicas si es necesario */
        .table-container th:nth-child(1), /* No. */
        .table-container td:nth-child(1),
        .table-container th:nth-child(15), /* Atendió */
        .table-container td:nth-child(15) {
            width: 30px;
        }

        .table-container th:nth-child(2), /* Fecha */
        .table-container td:nth-child(2){
            width: 60px;
        }
        
        .table-container th:nth-child(3), /* Inicio */
        .table-container td:nth-child(3),
        .table-container th:nth-child(4), /* Fin */
        .table-container td:nth-child(4),
        .table-container th:nth-child(5), /* Duración */
        .table-container td:nth-child(5),
        .table-container th:nth-child(6), /* Área */
        .table-container td:nth-child(6){
            width: 60px;
        }
        
        .table-container th:nth-child(16),
        .table-container td:nth-child(16) {
            max-width: 70px; /* Ancho máximo para la columna */
            white-space: normal; /* Permite que el texto se divida en líneas */
            word-wrap: break-word; /* Rompe palabras largas si es necesario */
        }

        .table-container th:nth-child(7), /* Institución */
        .table-container td:nth-child(7),
        .table-container th:nth-child(8), /* Asunto */
        .table-container td:nth-child(8),
        .table-container th:nth-child(9), /* Consulta */
        .table-container td:nth-child(9),
        .table-container th:nth-child(10), /* Nombre */
        .table-container td:nth-child(10),
        .table-container th:nth-child(11), /* Cargo */
        .table-container td:nth-child(11){
            width: 70px;
        }

        .flex-with-buttons {
            display: flex;
            align-items: flex-end;
        }

        .flex-with-buttons .select2-container {
            flex-grow: 1;
            margin-right: 0.25rem;
            margin-bottom: 1px; /* Alineación vertical */
        }

        .flex-with-buttons button {
            height: 38px;
            width: 38px;
            margin-bottom: 1px; /* Alineación vertical */
            flex-shrink: 0;
            border-radius: 0.25rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }

        .flex-with-buttons button.add-btn {
            background-color: #3b82f6; /* Azul */
            color: white;
            margin-right: 0.25rem;
        }

        .flex-with-buttons button.add-btn:hover {
            background-color: #2563eb; /* Azul más oscuro al pasar el mouse */
        }

        .flex-with-buttons button.edit-btn {
            background-color: #A6802D; /* Color secundario */
            color: white;
        }

        .flex-with-buttons button.edit-btn:hover {
            background-color: #8a6b22; /* Color secundario más oscuro */
        }

        .select2-container--default .select2-selection--single {
            height: 38px;
            padding: 5px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 26px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        @media (min-width: 640px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .form-field {
            margin-bottom: 0.5rem;
        }

        .form-field label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        /* Mejoras para el formulario de llamada */
        .call-form-container {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .call-form-container::-webkit-scrollbar {
            width: 6px;
        }

        .call-form-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .call-form-container::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }

        .call-form-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Estilos para el reporte ejecutivo */
        .reporte-ejecutivo {
            padding: 20px;
            background: white;
            font-family: 'Inter', sans-serif;
        }
        
        .reporte-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #9C2348;
            padding-bottom: 20px;
        }
        
        .reporte-metricas {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metrica {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #9C2348;
        }
        
        .graficas-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .grafica {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .tabla-datos {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        
        .tabla-datos th, .tabla-datos td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: left;
        }
        
        .tabla-datos th {
            background-color: #f9fafb;
        }
        
        .reporte-footer {
            text-align: center;
            margin-top: 30px;
            border-top: 1px solid #e5e7eb;
            padding-top: 20px;
            color: #6b7280;
        }

        /* Nuevos estilos para la versión 1.1 */
        .config-report-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        @media (min-width: 640px) {
            .config-report-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .config-option {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .config-option input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        .wide-modal .relative {
            max-width: 72rem !important; /* equivalente a max-w-6xl */
        }

        .bg-white.shadow-sm.sticky {
            margin-top: -1px !important;
        }
        
        #tabs {
            margin-top: 0 !important;
        }
        
        header + div {
            top: 56px !important;
        }
        
        .chart-size-control {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-size-control label {
            font-size: 14px;
            color: #374151;
        }
        
        .chart-size-control input {
            width: 150px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px; /* Altura por defecto, se ajustará con JS */
        }

        #reportes .grid {
            gap: 3rem 2rem; /* Aumenta el gap vertical y horizontal */
            margin-bottom: 2rem; /* Espacio extra al final */
        }

        /* Nuevos estilos para la versión 1.3 */
        .dynamic-chart-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .dynamic-chart-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }
        
        .dynamic-chart-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .dynamic-table-container {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .dynamic-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .dynamic-table th, .dynamic-table td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
        }
        
        .dynamic-table th {
            background-color: #9C2348;
            color: white;
            font-weight: 600;
        }
        
        .dynamic-table tr:nth-child(even) {
            background-color: #f3f4f6;
        }
        
        .info-tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        
        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #1E5B4F;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        
        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .migrate-btn {
            background-color: #1E5B4F !important;
        }
        
        .migrate-btn:hover {
            background-color: #16463c !important;
        }

    </style>
    
    <!-- Configuración de Tailwind con nueva paleta de colores -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#9C2348',
                            light: '#b52e5a',
                            dark: '#7d1c3a'
                        },
                        secondary: {
                            DEFAULT: '#A6802D',
                            light: '#bf9a41',
                            dark: '#8a6b22'
                        },
                        accent: {
                            DEFAULT: '#1E5B4F',
                            light: '#267c6c',
                            dark: '#16463c'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="antialiased text-slate-700">

    <div id="loader" class="loader">
        <div class="spinner"></div>
        <p class="mt-4 text-sm text-slate-600">Cargando datos, por favor espera...</p>
    </div>

    <div id="app" class="min-h-screen hidden">
        <header class="bg-primary shadow-lg sticky top-0 z-10">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <img src="https://www.gob.mx/static/images/logo-gobmex.png" alt="Gobierno de México" class="h-14 w-auto">
                    <h1 class="text-xl sm:text-2xl font-bold text-white tracking-tight">Sistema de Registro de Llamadas v1.3</h1>
                </div>
                <div id="user-info" class="text-white text-sm font-mono"></div>
            </div>
        </header>

        <div class="bg-white shadow-sm sticky top-[56px] z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="tabs" class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button data-tab="registro" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Registro y Control</button>
                        <button data-tab="historico" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Histórico</button>
                        <button data-tab="reportes" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Reportes y Gráficos</button>
                    </nav>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <main id="tab-content-registro" class="tab-content">
                <section id="dashboard" class="mb-8">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-primary mb-2 sm:mb-0">Dashboard General</h2>
                        <div class="flex items-center space-x-4">
                            <button id="migrate-calls-btn" class="migrate-btn text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2">
                                <i class="fa-solid fa-database"></i>
                                <span>Migrar Llamadas</span>
                                <div class="info-tooltip">
                                    <i class="fa-solid fa-circle-info"></i>
                                    <span class="tooltip-text">Mover todas las llamadas de Registro y Control al Histórico</span>
                                </div>
                            </button>
                            <label for="dashboard-data-source" class="block text-sm font-medium text-gray-700">Fuente de datos:</label>
                            <select id="dashboard-data-source" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                <option value="registro">Registro y Control</option>
                                <option value="historico">Histórico</option>
                                <option value="combinado">Registro y Control + Histórico</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4"><div class="bg-primary/10 p-3 rounded-full"><i class="fa-solid fa-phone-volume text-primary text-2xl"></i></div><div><p class="text-slate-500">Total de Llamadas</p><p id="total-calls" class="text-3xl font-bold text-primary">0</p></div></div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4"><div class="bg-primary/10 p-3 rounded-full"><i class="fa-solid fa-hourglass-half text-primary text-2xl"></i></div><div><p class="text-slate-500">Duración Promedio</p><p id="avg-duration" class="text-3xl font-bold text-primary">00:00</p></div></div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4"><div class="bg-accent/10 p-3 rounded-full"><i class="fa-solid fa-circle-check text-accent text-2xl"></i></div><div><p class="text-slate-500">Llamadas Atendidas</p><p id="atendidas-count" class="text-3xl font-bold text-accent">0</p></div></div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4"><div class="bg-danger/10 p-3 rounded-full"><i class="fa-solid fa-circle-xmark text-danger text-2xl"></i></div><div><p class="text-slate-500">Llamadas Pendientes</p><p id="pendientes-count" class="text-3xl font-bold text-danger">0</p></div></div>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-xl shadow-md mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="text-center md:text-left"><h3 class="text-xl font-semibold text-slate-800">Control de Llamadas</h3><p class="text-slate-500">Inicia una nueva llamada para activar el cronómetro y el formulario.</p></div>
                    <div class="flex items-center gap-6"><div class="text-center"><p class="text-sm font-medium text-slate-500">TIEMPO DE LLAMADA ACTUAL</p><p id="timer" class="text-4xl font-bold text-primary tracking-wider">00:00:00</p></div><button id="start-call-btn" class="bg-success hover:bg-success-dark text-white font-bold py-4 px-8 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out flex items-center space-x-3"><i class="fa-solid fa-phone-alt h-6 w-6"></i><span>Iniciar Nueva Llamada</span></button></div>
                </section>
                
                <section id="call-log">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-primary">Historial de Llamadas</h2><div class="flex items-center space-x-2"><div class="relative w-full"><input type="text" id="filter-input-main" placeholder="Buscar..." class="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"><i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i><button id="clear-filter-btn-main" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden"><i class="fa-solid fa-times-circle"></i></button></div><button id="download-excel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2"><i class="fa-solid fa-file-excel"></i><span>Descargar Excel</span></button></div></div>
                    <div class="bg-white rounded-xl shadow-md table-container">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr id="main-table-header">
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="no">No. <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="fecha">Fecha <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="inicio">Inicio <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="fin">Fin <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="duracion">Duración <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="area">Área <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="institucion">Institución <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="asunto">Asunto <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="consulta">Consulta <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="nombre">Nombre <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="cargo">Cargo <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="correo">Correo <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="telefono">Teléfono <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="estatus">Estatus <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="atendio">Atendió <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="comentarios">Comentarios <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="calls-table-body"></tbody>
                        </table>
                        <div id="no-calls-message" class="p-6 text-center text-slate-500 hidden"><p>No hay llamadas registradas en la base de datos.</p></div>
                    </div>
                </section>
            </main>

            <div id="tab-content-historico" class="tab-content hidden">
                <section class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-primary mb-4">Cargar Histórico desde Excel</h2>
                    <div class="flex flex-col md:flex-row items-center gap-4"><label for="historical-file-input" class="w-full md:w-auto cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 px-6 rounded-lg shadow-sm transition-all duration-200 ease-in-out text-center flex-grow"><i class="fa-solid fa-file-upload mr-2"></i><span id="file-name">Seleccionar archivo Excel (.xlsx)</span><input type="file" id="historical-file-input" class="hidden" accept=".xlsx, .xls"></label><button id="import-historical-btn" class="w-full md:w-auto bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled><i class="fa-solid fa-database mr-2"></i>Importar a la Base de Datos</button></div>
                </section>
                
                <section id="historical-log" class="mt-8">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-primary">Registro Histórico</h2><div class="flex items-center space-x-2"><div class="relative w-full"><input type="text" id="filter-input-historical" placeholder="Buscar..." class="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"><i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i><button id="clear-filter-btn-historical" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden"><i class="fa-solid fa-times-circle"></i></button></div><button id="download-historical-excel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2"><i class="fa-solid fa-file-excel"></i><span>Descargar Histórico</span></button></div></div>
                    <div class="bg-white rounded-xl shadow-md table-container">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr id="historical-table-header">
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="no">No.</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="fecha">Fecha</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="inicio">Inicio</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="fin">Fin</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="duracion">Duración</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="area">Área</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="institucion">Institución</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="asunto">Asunto</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="consulta">Consulta</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="nombre">Nombre</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="cargo">Cargo</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="correo">Correo</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="telefono">Teléfono</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="estatus">Estatus</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="atendio">Atendió</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="comentarios">Comentarios</th>
                                    <th scope="col" class="py-3 px-6">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="historical-table-body"></tbody>
                        </table>
                        <div id="no-historical-message" class="p-6 text-center text-slate-500 hidden"><p>No hay datos históricos cargados.</p></div>
                    </div>
                </section>
            </div>

            <div id="tab-content-reportes" class="tab-content hidden">
                <section id="reportes" class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-primary">Reportes</h2>

                        <div class="flex items-center space-x-4">
                            <button id="generate-report-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2">
                                <i class="fa-solid fa-file-pdf"></i>
                                <span>Generar Reporte</span>
                            </button>
                            <div class="flex items-center space-x-2">
                                <label for="reportes-data-source" class="block text-sm font-medium text-gray-700">Fuente de datos:</label>
                                <select id="reportes-data-source" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                    <option value="registro">Registro y Control</option>
                                    <option value="historico">Histórico</option>
                                    <option value="combinado">Registro y Control + Histórico</option>
                                </select>
                                <button id="config-report-btn" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 ease-in-out ml-2">
                                    <i class="fa-solid fa-cog fa-lg"></i>
                                </button>
                            </div>
                        </div>

                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2">
                        <div class="chart-wrapper">
                            <h3 class="text-xl font-semibold text-slate-800 mb-2">Llamadas por Estatus</h3>
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <h3 class="text-xl font-semibold text-slate-800 mb-2">Llamadas por Asunto</h3>
                            <canvas id="asuntoChart"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <h3 class="text-xl font-semibold text-slate-800 mb-2">Llamadas por Día de la Semana</h3>
                            <canvas id="dayOfWeekChart"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <h3 class="text-xl font-semibold text-slate-800 mb-2">Llamadas atendidas por Servidor Público</h3>
                            <canvas id="atendioChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Nueva gráfica dinámica -->
                    <div class="dynamic-chart-container">
                        <div class="dynamic-chart-header">
                            <h3 class="text-xl font-semibold text-slate-800">Llamadas por</h3>
                            <select id="dynamic-chart-variable" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                <option value="area">Área</option>
                                <option value="institucion">Institución</option>
                                <option value="asunto">Asunto</option>
                                <option value="consulta">Consulta</option>
                                <option value="nombre">Nombre</option>
                                <option value="cargo">Cargo</option>
                            </select>
                        </div>
                        <div class="dynamic-chart-content">
                            <div class="chart-wrapper">
                                <canvas id="dynamicChart"></canvas>
                            </div>
                            <div class="dynamic-table-container">
                                <h4 class="text-lg font-semibold text-slate-800 mb-2 text-center">Distribución por Estatus</h4>
                                <table class="dynamic-table">
                                    <thead>
                                        <tr>
                                            <th id="dynamic-table-header">Variable</th>
                                            <th>Atendida</th>
                                            <th>Pendiente</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dynamic-table-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
                <section class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-primary mb-4">Tabla Dinámica Interactiva</h2>
                    <p class="text-slate-500 mb-4">Selecciona variables para cruzar datos y genera gráficos dinámicos (tablas, barras, líneas, heatmaps, etc.).</p>
                    <div id="pivot-table"></div>
                </section>
            </div>
        </div>
    </div>
    
    <!-- Modales -->
    <div id="call-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-6xl mx-4">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fa-solid fa-times-circle fa-lg"></i></button>
            <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold text-primary">Detalles de la Llamada</h3><div class="text-right"><p class="text-sm font-medium text-slate-500">TIEMPO DE LLAMADA ACTUAL</p><p id="modal-timer" class="text-2xl font-bold text-primary tracking-wider">00:00:00</p></div></div>
            <div class="call-form-container">
                <form id="call-form" class="space-y-6" novalidate>
                    <div> 
                        <h4 class="section-title text-lg">Datos Institución</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="caller-institution">Institución</label>
                                <div class="flex-with-buttons">
                                    <select id="caller-institution" name="institucion" required></select>
                                    <button type="button" id="add-institution-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-institution-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="call-area">Área o Departamento</label>
                                <div class="flex-with-buttons">
                                    <select id="call-area" name="area" required></select>
                                    <button type="button" id="add-area-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-area-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="call-subject">Asunto</label>
                                <div class="flex-with-buttons">
                                    <select id="call-subject" name="asunto" required></select>
                                    <button type="button" id="add-subject-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-subject-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="call-query">Consulta</label>
                                <div class="flex-with-buttons">
                                    <select id="call-query" name="consulta" required></select>
                                    <button type="button" id="add-query-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-query-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="section-title text-lg">Datos Personales</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="caller-name">Nombre del Solicitante</label>
                                <div class="flex-with-buttons">
                                    <select id="caller-name" name="nombre" required></select>
                                    <button type="button" id="add-name-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-name-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="caller-cargo">Cargo del Solicitante</label>
                                <div class="flex-with-buttons">
                                    <select id="caller-cargo" name="cargo" required></select>
                                    <button type="button" id="add-cargo-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-cargo-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="caller-email">Correo Electrónico</label>
                                <div class="flex-with-buttons">
                                    <select id="caller-email" name="correo" required></select>
                                    <button type="button" id="add-email-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-email-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="caller-phone">Teléfono (opcional)</label>
                                <div class="flex-with-buttons">
                                    <select id="caller-phone" name="telefono"></select>
                                    <button type="button" id="add-phone-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-phone-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="section-title text-lg">Atendió y Comentarios</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="call-atendio">Atendió</label>
                                <div class="flex-with-buttons">
                                    <select id="call-atendio" name="atendio" required></select>
                                    <button type="button" id="add-atendio-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-atendio-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="call-comments">Comentarios</label>
                                <div class="flex-with-buttons">
                                     <select id="call-comments" name="comentarios"></select>
                                     <button type="button" id="add-comments-btn" class="add-btn">+</button>
                                     <button type="button" id="edit-comments-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-end pt-4"><button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar y Finalizar Llamada</button></div>
                </form>
            </div>
        </div>
    </div>
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-6xl mx-4">
            <button id="close-edit-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fa-solid fa-times-circle fa-lg"></i></button>
            <h3 class="text-2xl font-bold text-primary mb-6">Editar Llamada</h3>
            <div class="call-form-container">
                <form id="edit-form" class="space-y-6" novalidate>
                    <input type="hidden" id="edit-id">
                    <div>
                        <h4 class="section-title text-lg">Datos Institución</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="edit-caller-institution" class="block text-sm font-medium text-gray-700">Institución</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-caller-institution" name="institucion" class="mt-1 block w-full" required></select>
                                    <button type="button" id="add-institution-edit-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-institution-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-call-area" class="block text-sm font-medium text-gray-700">Área</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-call-area" name="area" class="mt-1 block w-full" required></select>
                                    <button type="button" id="add-area-edit-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-area-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-call-subject" class="block text-sm font-medium text-gray-700">Asunto</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-call-subject" name="asunto" class="mt-1 block w-full" required></select>
                                    <button type="button" id="add-subject-edit-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-subject-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-call-query" class="block text-sm font-medium text-gray-700">Consulta</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-call-query" name="consulta" class="mt-1 block w-full" required></select>
                                    <button type="button" id="add-query-edit-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-query-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="section-title text-lg">Datos Personales</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="edit-caller-name" class="block text-sm font-medium text-gray-700">Nombre</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-caller-name" name="nombre" class="mt-1 block w-full" required></select>
                                    <button type="button" id="add-name-edit-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-name-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-caller-cargo" class="block text-sm font-medium text-gray-700">Cargo</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-caller-cargo" name="cargo" class="mt-1 block w-full" required></select>
                                    <button type="button" id="add-cargo-edit-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-cargo-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-caller-email" class="block text-sm font-medium text-gray-700">Correo</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-caller-email" name="correo" class="mt-1 block w-full" required></select>
                                    <button type="button" id="add-email-edit-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-email-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-caller-phone" class="block text-sm font-medium text-gray-700">Teléfono (opcional)</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-caller-phone" name="telefono" class="mt-1 block w-full"></select>
                                    <button type="button" id="add-phone-edit-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-phone-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="section-title text-lg">Atendió y Comentarios</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="edit-call-atendio" class="block text-sm font-medium text-gray-700">Atendió</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-call-atendio" name="atendio" class="mt-1 block w-full" required></select>
                                    <button type="button" id="add-atendio-edit-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-atendio-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-call-comments" class="block text-sm font-medium text-gray-700">Comentarios</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-call-comments" name="comentarios" class="mt-1 block w-full"></select>
                                    <button type="button" id="add-comments-edit-btn" class="add-btn">+</button>
                                    <button type="button" id="edit-comments-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-end pt-4"><button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar Cambios</button></div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center"><h3 class="text-xl font-bold text-slate-800 mb-4">Confirmar Eliminación</h3><p class="text-slate-600 mb-6">¿Estás seguro de que deseas eliminar este registro?</p><div class="flex justify-center space-x-4"><button id="cancel-delete-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button><button id="confirm-delete-btn" class="bg-danger hover:bg-danger-dark text-white font-bold py-2 px-4 rounded-lg">Eliminar</button></div></div>
    </div>

    <div id="replace-historical-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center"><h3 class="text-xl font-bold text-primary mb-4">Reemplazar Histórico</h3><p class="text-slate-600 mb-6">¿Desea reemplazar el histórico actual?</p><div class="flex justify-center space-x-4"><button id="cancel-replace-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">No</button><button id="confirm-replace-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Sí</button></div></div>
    </div>

    <div id="add-option-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Agregar Nueva Opción</h3>
            <input type="text" id="new-option-input" placeholder="Ingrese la nueva opción" class="w-full p-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-center space-x-4">
                <button id="cancel-add-option-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-add-option-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Agregar</button>
            </div>
        </div>
    </div>

    <div id="edit-option-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Editar Opción</h3>
            <input type="text" id="edit-option-input" placeholder="Edite la opción" class="w-full p-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-center space-x-4">
                <button id="cancel-edit-option-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-edit-option-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Guardar</button>
            </div>
        </div>
    </div>

    <div id="password-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Verificación de Seguridad</h3>
            <p class="text-slate-600 mb-4">Esta acción requiere autenticación. Por favor, ingrese la contraseña.</p>
            <input type="password" id="password-input" placeholder="Contraseña" class="w-full p-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-center space-x-4">
                <button id="cancel-password-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-password-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Verificar</button>
            </div>
        </div>
    </div>

    <div id="report-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <button id="close-report-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fa-solid fa-times-circle fa-lg"></i></button>
            <h3 class="text-2xl font-bold text-primary mb-6">Generar Reporte Ejecutivo</h3>
            <form id="report-form" class="space-y-6">
                <div>
                    <h4 class="section-title text-lg">Seleccionar gráficas a incluir</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="include-status" class="rounded border-gray-300 text-primary focus:ring-primary" checked>
                            <label for="include-status" class="ml-2 block text-sm text-gray-700">Llamadas por Estatus</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="include-asunto" class="rounded border-gray-300 text-primary focus:ring-primary" checked>
                            <label for="include-asunto" class="ml-2 block text-sm text-gray-700">Llamadas por Asunto</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="include-day" class="rounded border-gray-300 text-primary focus:ring-primary" checked>
                            <label for="include-day" class="ml-2 block text-sm text-gray-700">Llamadas por Día de la Semana</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="include-atendio" class="rounded border-gray-300 text-primary focus:ring-primary" checked>
                            <label for="include-atendio" class="ml-2 block text-sm text-gray-700">Llamadas por Servidor Público</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="include-dynamic" class="rounded border-gray-300 text-primary focus:ring-primary" checked>
                            <label for="include-dynamic" class="ml-2 block text-sm text-gray-700">Llamadas por Variable Seleccionada</label>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center justify-end pt-4">
                    <button type="button" id="generate-pdf-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Generar Reporte PDF</button>
                </div>
            </form>
        </div>
    </div>

    <div id="config-report-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <button id="close-config-report-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fa-solid fa-times-circle fa-lg"></i></button>
            
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-primary">Configuración de Reportes</h3>
                <div class="relative group">
                    <button type="button" class="text-primary hover:text-primary-dark focus:outline-none">
                        <i class="fa-solid fa-circle-info fa-lg"></i>
                    </button>
                    <div class="absolute hidden group-hover:block right-0 top-full mt-2 w-64 p-2 bg-white shadow-lg rounded-lg border border-gray-200 z-10 text-sm text-gray-600">
                        Seleccione un período para filtrar los reportes. Ejemplo: para ver datos del 15/04/2025, establezca la fecha de inicio 14/04/2025 y fecha de fin en 16/04/2025. 
                    </div>
                </div>
            </div>
            
            <form id="config-report-form" class="space-y-6">
                <div class="config-report-grid">
                    <div class="config-option">
                        <input type="radio" id="filter-all-data" name="data-filter" value="all" checked class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="filter-all-data" class="block text-sm font-medium text-gray-700">Todos los datos</label>
                    </div>
                    
                    <div class="config-option">
                        <input type="radio" id="filter-by-period" name="data-filter" value="period" class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="filter-by-period" class="block text-sm font-medium text-gray-700">Seleccionar por periodo</label>
                    </div>
                    
                    <div class="form-field">
                        <label for="config-report-start-date">Fecha de inicio</label>
                        <input type="date" id="config-report-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" disabled>
                    </div>
                    
                    <div class="form-field">
                        <label for="config-report-end-date">Fecha de fin</label>
                        <input type="date" id="config-report-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" disabled>
                    </div>
                </div>

                <div class="chart-size-control">
                    <label for="chart-size-slider" class="font-medium text-gray-700">Tamaño de gráficas:</label>
                    <input type="range" id="chart-size-slider" min="200" max="400" value="200" class="w-40">
                    <span id="chart-size-value" class="text-sm text-gray-600">200px</span>
                </div>
                
                <div class="flex items-center justify-end pt-4">
                    <button type="button" id="save-config-report-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar Configuración</button>
                </div>
            </form>
        </div>
    </div>

    <div id="migrate-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Migrar Llamadas</h3>
            <p class="text-slate-600 mb-6">¿Está seguro de que desea migrar todas las llamadas de Registro y Control al Histórico? Esta acción no se puede deshacer.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-migrate-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-migrate-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Migrar</button>
            </div>
        </div>
    </div>

    <div id="report-preview" class="hidden"></div>

    <script type="module">
        // =============================================
        // MÓDULO: Configuración de Firebase
        // =============================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, writeBatch, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBdiTQPTIklfTx4W4_cWn4wule50FKXknY",
            authDomain: "llamadasicoin.firebaseapp.com",
            projectId: "llamadasicoin",
            storageBucket: "llamadasicoin.appspot.com",
            messagingSenderId: "689552307207",
            appId: "1:689552307207:web:a18fdf88cdf2583fa466a2",
            measurementId: "G-Z97PD6VZR4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // =============================================
        // MÓDULO: Variables globales y estado de la aplicación
        // =============================================
        let timerInterval;
        let callStartTime;
        let calls = [];
        let historicalCalls = [];
        let userId;
        
        const callsCollectionRef = collection(db, "calls");
        const historicalCallsCollectionRef = collection(db, "historicalCalls");
        
        // Elementos del DOM
        const loader = document.getElementById('loader');
        const appContainer = document.getElementById('app');
        const userInfo = document.getElementById('user-info');
        const tabsContainer = document.getElementById('tabs');
        const tabContents = document.querySelectorAll('.tab-content');
        const dashboardDataSource = document.getElementById('dashboard-data-source');
        const totalCallsElem = document.getElementById('total-calls');
        const avgDurationElem = document.getElementById('avg-duration');
        const atendidasCountElem = document.getElementById('atendidas-count');
        const pendientesCountElem = document.getElementById('pendientes-count');
        const timerElem = document.getElementById('timer');
        const startCallBtn = document.getElementById('start-call-btn');
        const downloadExcelBtn = document.getElementById('download-excel-btn');
        const callLogTableBody = document.getElementById('calls-table-body');
        const noCallsMessage = document.getElementById('no-calls-message');
        const historicalTableBody = document.getElementById('historical-table-body');
        const noHistoricalMessage = document.getElementById('no-historical-message');
        const historicalFileInput = document.getElementById('historical-file-input');
        const historicalFileName = document.getElementById('file-name');
        const importHistoricalBtn = document.getElementById('import-historical-btn');
        const reportesDataSource = document.getElementById('reportes-data-source');
        const statusChartCanvas = document.getElementById('statusChart');
        const asuntoChartCanvas = document.getElementById('asuntoChart');
        const dayOfWeekChartCanvas = document.getElementById('dayOfWeekChart');
        const atendioChartCanvas = document.getElementById('atendioChart');
        const dynamicChartCanvas = document.getElementById('dynamicChart');
        const dynamicChartVariable = document.getElementById('dynamic-chart-variable');
        const dynamicTableBody = document.getElementById('dynamic-table-body');
        const dynamicTableHeader = document.getElementById('dynamic-table-header');
        let statusChart, asuntoChart, dayOfWeekChart, atendioChart, dynamicChart;
        const callModal = document.getElementById('call-modal');
        const callForm = document.getElementById('call-form');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const modalTimerElem = document.getElementById('modal-timer');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const pivotTableContainer = document.getElementById('pivot-table');
        const replaceHistoricalModal = document.getElementById('replace-historical-modal');
        const cancelReplaceBtn = document.getElementById('cancel-replace-btn');
        const confirmReplaceBtn = document.getElementById('confirm-replace-btn');
        const addOptionModal = document.getElementById('add-option-modal');
        const newOptionInput = document.getElementById('new-option-input');
        const cancelAddOptionBtn = document.getElementById('cancel-add-option-btn');
        const confirmAddOptionBtn = document.getElementById('confirm-add-option-btn');
        const editOptionModal = document.getElementById('edit-option-modal');
        const editOptionInput = document.getElementById('edit-option-input');
        const cancelEditOptionBtn = document.getElementById('cancel-edit-option-btn');
        const confirmEditOptionBtn = document.getElementById('confirm-edit-option-btn');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const cancelPasswordBtn = document.getElementById('cancel-password-btn');
        const confirmPasswordBtn = document.getElementById('confirm-password-btn');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const configReportBtn = document.getElementById('config-report-btn');
        const reportModal = document.getElementById('report-modal');
        const closeReportModalBtn = document.getElementById('close-report-modal-btn');
        const reportForm = document.getElementById('report-form');
        const generatePdfBtn = document.getElementById('generate-pdf-btn');
        const configReportModal = document.getElementById('config-report-modal');
        const closeConfigReportModalBtn = document.getElementById('close-config-report-modal-btn');
        const configReportForm = document.getElementById('config-report-form');
        const saveConfigReportBtn = document.getElementById('save-config-report-btn');
        const filterAllDataRadio = document.getElementById('filter-all-data');
        const filterByPeriodRadio = document.getElementById('filter-by-period');
        const configReportStartDate = document.getElementById('config-report-start-date');
        const configReportEndDate = document.getElementById('config-report-end-date');
        const reportPreview = document.getElementById('report-preview');
        const chartSizeSlider = document.getElementById('chart-size-slider');
        const chartSizeValue = document.getElementById('chart-size-value');
        const migrateCallsBtn = document.getElementById('migrate-calls-btn');
        const migrateModal = document.getElementById('migrate-modal');
        const cancelMigrateBtn = document.getElementById('cancel-migrate-btn');
        const confirmMigrateBtn = document.getElementById('confirm-migrate-btn');
        const includeDynamicCheckbox = document.getElementById('include-dynamic');
        
        let currentEditIsHistorical = false;
        
        let fieldOptions = {
            areas: [],
            asuntos: [],
            consultas: [],
            nombres: [],
            cargos: [],
            correos: [],
            telefonos: [],
            comentarios: [],
            instituciones: [],
            atendioUsers: []
        };

        let currentEditingField = null;
        let currentEditingValue = null;
        let pendingAction = null;
        let reportFilter = {
            type: 'all', // 'all' o 'period'
            startDate: null,
            endDate: null
        };

        // =============================================
        // MÓDULO: Utilidades
        // =============================================
        
        function showApp() {
            loader.classList.add('hidden');
            appContainer.classList.remove('hidden');
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.createElement('div');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-gray-500' };
            alertContainer.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white transform transition-all duration-300 z-[60] ${colors[type]}`;
            alertContainer.textContent = message;
            document.body.appendChild(alertContainer);
            setTimeout(() => { alertContainer.remove(); }, 3000);
        }
        
        function formatDuration(seconds) {
            if (isNaN(seconds) || seconds < 0) seconds = 0;
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        
        function formatTimeWithAmPm(timeString) {
            if (!timeString || typeof timeString !== 'string') return 'N/A';
            if (timeString.toLowerCase().includes('a. m.') || timeString.toLowerCase().includes('p. m.')) {
                return timeString;
            }
            try {
                const [hours, minutes, seconds = '00'] = timeString.split(':');
                let h = parseInt(hours, 10);
                const m = minutes.padStart(2, '0');
                const s = seconds.padStart(2, '0');
                const period = h >= 12 ? 'p. m.' : 'a. m.';
                h = h % 12 || 12;
                return `${h.toString().padStart(2, '0')}:${m}:${s} ${period}`;
            } catch (e) {
                return timeString;
            }
        }

        function openModal(modal) {
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
        }

        function closeModal(modal) {
            modal.classList.remove('modal-enter');
            modal.classList.add('modal-leave');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // =============================================
        // MÓDULO: Interfaz de usuario
        // =============================================
        
        function setupTabs() {
            tabsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    const tabName = e.target.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `tab-content-${tabName}`));
                    if (tabName === 'reportes') {
                        setTimeout(updateCharts, 50); // Delay to ensure container is visible
                    }
                }
            });
        }

        function renderTable(tableBody, data, isHistorical = false) {
            const noDataMessage = isHistorical ? noHistoricalMessage : noCallsMessage;
            tableBody.innerHTML = '';
            noDataMessage.classList.toggle('hidden', data.length > 0);

            const headers = ['no', 'fecha', 'inicio', 'fin', 'duracion', 'area', 'institucion', 'asunto', 'consulta', 'nombre', 'cargo', 'correo', 'telefono', 'estatus', 'atendio', 'comentarios'];

            data.forEach((call, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                
                let cells = headers.map(header => {
                    let content = '';
                    if (header === 'no') content = index + 1;
                    else if (header === 'duracion') content = formatDuration(call.duracion);
                    else if (header === 'estatus') {
                        content = `<button data-id="${call.id}" class="status-button status-${call.estatus === 'Atendida' ? 'atendida' : 'pendiente'} toggle-status-btn" data-is-historical="${isHistorical}">${call.estatus || 'Pendiente'}</button>`;
                    } else if (header === 'inicio' || header === 'fin') {
                        content = formatTimeWithAmPm(call[header]);
                    } else {
                        content = call[header] || 'N/A';
                    }
                    return `<td class="py-4 px-6">${content}</td>`;
                }).join('');

                const actionsCell = `<td class="py-4 px-6 flex space-x-2">
                        <button data-id="${call.id}" data-is-historical="${isHistorical}" class="edit-btn text-blue-500 hover:text-blue-700"><i class="fa-solid fa-edit"></i></button>
                        <button data-id="${call.id}" data-is-historical="${isHistorical}" class="delete-btn text-red-500 hover:text-red-700"><i class="fa-solid fa-trash-alt"></i></button>
                    </td>`;
                
                row.innerHTML = cells + actionsCell;
                tableBody.appendChild(row);
            });
        }
        
        function setupSorting(headerId, tableBody, dataProvider, renderFunc) {
            document.getElementById(headerId).addEventListener('click', (e) => {
                const header = e.target.closest('.sortable-header');
                if (!header) return;
                
                const sortBy = header.dataset.sortBy;
                let sortOrder = header.dataset.sortOrder === 'asc' ? 'desc' : 'asc';

                document.querySelectorAll(`#${headerId} .sortable-header`).forEach(h => {
                    h.dataset.sortOrder = ''; h.classList.remove('asc', 'desc');
                });
                header.dataset.sortOrder = sortOrder; header.classList.add(sortOrder);
                
                const data = dataProvider();
                const sortedData = [...data].sort((a, b) => {
                    const valA = a[sortBy] || ''; const valB = b[sortBy] || '';
                    const comparison = typeof valA === 'string' ? valA.localeCompare(valB, 'es', { numeric: true }) : valA - valB;
                    return sortOrder === 'asc' ? comparison : -comparison;
                });
                renderFunc(tableBody, sortedData, headerId.includes('historical'));
            });
        }
        
        function setupFiltering(inputId, tableBody, dataProvider, renderFunc, isHistorical = false) {
            const filterInput = document.getElementById(inputId);
            const clearFilterBtn = document.getElementById(`clear-filter-btn-${inputId.split('-')[2]}`);
            filterInput.addEventListener('input', () => {
                const filterText = filterInput.value.toLowerCase();
                clearFilterBtn.classList.toggle('hidden', !filterText);
                const data = dataProvider();
                const filteredData = data.filter(call => Object.values(call).some(value => String(value).toLowerCase().includes(filterText)));
                renderFunc(tableBody, filteredData, isHistorical);
            });
            clearFilterBtn.addEventListener('click', () => {
                filterInput.value = ''; filterInput.dispatchEvent(new Event('input'));
            });
        }

        function sortAndRenderTable(tableBody, data, isHistorical) {
            const sortedData = [...data].sort((a, b) => {
                const dateA = new Date(a.fecha?.split('/').reverse().join('-'));
                const dateB = new Date(b.fecha?.split('/').reverse().join('-'));
                if (isNaN(dateA)) return 1;
                if (isNaN(dateB)) return -1;
                return dateB - dateA;
            });
            renderTable(tableBody, sortedData, isHistorical);
        }

        function updateDashboard() {
            const source = dashboardDataSource.value;
            let data = [];
            if (source === 'registro') data = calls;
            else if (source === 'historico') data = historicalCalls;
            else data = [...calls, ...historicalCalls];
            
            const totalCalls = data.length;
            const atendidas = data.filter(c => c.estatus === 'Atendida').length;
            const pendientes = totalCalls - atendidas;
            const totalDuration = data.reduce((sum, c) => sum + (Number(c.duracion) || 0), 0);
            const avgDuration = totalCalls > 0 ? Math.round(totalDuration / totalCalls) : 0;

            totalCallsElem.textContent = totalCalls;
            avgDurationElem.textContent = formatDuration(avgDuration);
            atendidasCountElem.textContent = atendidas;
            pendientesCountElem.textContent = pendientes;
        }

        // =============================================
        // MÓDULO: Gestión de llamadas
        // =============================================
        
        function startTimer() {
            startCallBtn.dataset.state = 'active';
            startCallBtn.innerHTML = `<i class="fa-solid fa-stopwatch h-6 w-6"></i><span>Finalizar Llamada</span>`;
            startCallBtn.classList.replace('bg-success', 'bg-danger');
            startCallBtn.classList.replace('hover:bg-success-dark', 'hover:bg-danger-dark');
            
            callForm.reset();
            // Reset all select2 fields
            $('#call-form select').val(null).trigger('change');
            openModal(callModal);

            callStartTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                const formattedTime = formatDuration(elapsed);
                timerElem.textContent = formattedTime;
                modalTimerElem.textContent = formattedTime;
            }, 1000);
        }
        
        function stopTimer(shouldSave = true) {
            clearInterval(timerInterval);
            if (shouldSave) {
                const endTime = new Date();
                const duration = Math.floor((endTime - callStartTime) / 1000);
                const formData = new FormData(callForm);
                const callData = Object.fromEntries(formData.entries());
                
                callData.fecha = new Date(callStartTime).toLocaleDateString('es-ES');
                callData.inicio = new Date(callStartTime).toLocaleTimeString('es-ES', { hour12: false });
                callData.fin = endTime.toLocaleTimeString('es-ES', { hour12: false });
                callData.duracion = duration;
                callData.estatus = 'Atendida';
                saveCall(callData);
            }
            
            startCallBtn.dataset.state = 'inactive';
            startCallBtn.innerHTML = `<i class="fa-solid fa-phone-alt h-6 w-6"></i><span>Iniciar Nueva Llamada</span>`;
            startCallBtn.classList.replace('bg-danger', 'bg-success');
            startCallBtn.classList.replace('hover:bg-danger-dark', 'hover:bg-success-dark');
            resetTimer();
        }

        function resetTimer() {
            timerElem.textContent = '00:00:00';
            modalTimerElem.textContent = '00:00:00';
        }
        
        async function saveCall(callData) {
            try {
                await addDoc(callsCollectionRef, { ...callData, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
                showAlert("Llamada guardada con éxito!", "success");
            } catch (error) {
                console.error("Error al guardar la llamada:", error);
                showAlert(`Error al guardar: ${error.message}`, "error");
            }
        }
        
        async function updateCall(id, updateData, isHistorical) {
            try {
                const collectionRef = isHistorical ? historicalCallsCollectionRef : callsCollectionRef;
                const callDocRef = doc(db, collectionRef.path, id);
                await updateDoc(callDocRef, { ...updateData, updatedAt: serverTimestamp() });
                showAlert("Llamada actualizada con éxito!", "success");
            } catch (error) {
                console.error("Error al actualizar la llamada:", error);
                showAlert(`Error al actualizar: ${error.message}`, "error");
            }
        }
        
        async function deleteCall(id, isHistorical) {
            try {
                const collectionRef = isHistorical ? historicalCallsCollectionRef : callsCollectionRef;
                const callDocRef = doc(db, collectionRef.path, id);
                await deleteDoc(callDocRef);
                showAlert("Llamada eliminada con éxito!", "success");
            } catch (error) {
                console.error("Error al eliminar la llamada:", error);
                showAlert(`Error al eliminar: ${error.message}`, "error");
            }
        }

        function handleEditClick(e) {
            requirePassword(() => {
                const callId = e.currentTarget.dataset.id;
                const isHistorical = e.currentTarget.dataset.isHistorical === 'true';
                currentEditIsHistorical = isHistorical;
                const allData = isHistorical ? historicalCalls : calls;
                const callToEdit = allData.find(call => call.id === callId);
                if (!callToEdit) return;

                document.getElementById('edit-id').value = callId;
                
                // Actualizar Select2 para todos los campos
                $('#edit-caller-institution').val(callToEdit.institucion || '').trigger('change');
                $('#edit-call-area').val(callToEdit.area || '').trigger('change');
                $('#edit-call-subject').val(callToEdit.asunto || '').trigger('change');
                $('#edit-call-query').val(callToEdit.consulta || '').trigger('change');
                $('#edit-caller-name').val(callToEdit.nombre || '').trigger('change');
                $('#edit-caller-cargo').val(callToEdit.cargo || '').trigger('change');
                $('#edit-caller-email').val(callToEdit.correo || '').trigger('change');
                $('#edit-caller-phone').val(callToEdit.telefono || '').trigger('change');
                $('#edit-call-comments').val(callToEdit.comentarios || '').trigger('change');
                $('#edit-call-atendio').val(callToEdit.atendio || '').trigger('change');

                openModal(editModal);
            });
        }

        async function handleStatusToggle(e) {
            const button = e.currentTarget;
            const callId = button.dataset.id;
            const isHistorical = button.dataset.isHistorical === 'true';
            const currentStatus = button.textContent.trim();
            const newStatus = currentStatus === 'Atendida' ? 'Pendiente' : 'Atendida';
            await updateCall(callId, { estatus: newStatus }, isHistorical);
        }

        function handleDeleteClick(e) {
            requirePassword(() => {
                callToDeleteId = e.currentTarget.dataset.id;
                callToDeleteIsHistorical = e.currentTarget.dataset.isHistorical === 'true';
                openModal(confirmModal);
            });
        }

        // =============================================
        // MÓDULO: Gestión de datos históricos
        // =============================================
        
        async function deleteAllHistorical() {
            const batch = writeBatch(db);
            historicalCalls.forEach(call => {
                const ref = doc(historicalCallsCollectionRef, call.id);
                batch.delete(ref);
            });
            await batch.commit();
        }

        async function importHistoricalData(data) {
            try {
                const batch = writeBatch(db);
                data.forEach(item => {
                    const docRef = doc(historicalCallsCollectionRef);
                    batch.set(docRef, { ...item, importedAt: serverTimestamp() });
                });
                await batch.commit();
                showAlert(`Se han importado ${data.length} registros históricos.`, "success");
            } catch (error) {
                console.error("Error al importar datos históricos:", error);
                showAlert(`Error al importar: ${error.message}`, "error");
            }
        }

        // =============================================
        // MÓDULO: Gestión de opciones dinámicas y autocompletado
        // =============================================
        
        function updateDynamicSelectOptions() {
            const allData = [...calls, ...historicalCalls];
            
            fieldOptions.areas = [...new Set(allData.map(c => c.area).filter(Boolean))].sort();
            fieldOptions.asuntos = [...new Set(allData.map(c => c.asunto).filter(Boolean))].sort();
            fieldOptions.consultas = [...new Set(allData.map(c => c.consulta).filter(Boolean))].sort();
            fieldOptions.nombres = [...new Set(allData.map(c => c.nombre).filter(Boolean))].sort();
            fieldOptions.cargos = [...new Set(allData.map(c => c.cargo).filter(Boolean))].sort();
            fieldOptions.correos = [...new Set(allData.map(c => c.correo).filter(Boolean))].sort();
            fieldOptions.telefonos = [...new Set(allData.map(c => c.telefono).filter(Boolean))].sort();
            fieldOptions.comentarios = [...new Set(allData.map(c => c.comentarios).filter(Boolean))].sort();
            fieldOptions.instituciones = [...new Set(allData.map(c => c.institucion).filter(Boolean))].sort();
            fieldOptions.atendioUsers = [...new Set(allData.map(c => c.atendio).filter(Boolean))].sort();
            
            Object.keys(fieldOptions).forEach(field => {
                updateSelectOptions(field, fieldOptions[field]);
            });
        }

        function updateSelectOptions(field, options) {
            const fieldToSelectMap = {
                'instituciones': ['caller-institution', 'edit-caller-institution'],
                'areas': ['call-area', 'edit-call-area'],
                'asuntos': ['call-subject', 'edit-call-subject'],
                'consultas': ['call-query', 'edit-call-query'],
                'nombres': ['caller-name', 'edit-caller-name'],
                'cargos': ['caller-cargo', 'edit-caller-cargo'],
                'correos': ['caller-email', 'edit-caller-email'],
                'telefonos': ['caller-phone', 'edit-caller-phone'],
                'comentarios': ['call-comments', 'edit-call-comments'],
                'atendioUsers': ['call-atendio', 'edit-call-atendio']
            };
            
            if (fieldToSelectMap[field]) {
                fieldToSelectMap[field].forEach(selectId => {
                    const select = $(`#${selectId}`);
                    if (select.length) {
                        const currentValue = select.val();
                        select.empty().select2({
                            data: options,
                            tags: true,
                            placeholder: "Seleccione o escriba una opción",
                            allowClear: true,
                            width: '100%'
                        }).val(currentValue).trigger('change.select2');
                    }
                });
            }
        }

        function setupAutofill() {
            // Función para cargar los detalles del contacto
            function loadContactDetails(name, institution, isEditModal) {
                if (!name || !institution) return;

                const allData = [...calls, ...historicalCalls];
                const records = allData
                    .filter(c => c.nombre === name && c.institucion === institution)
                    .sort((a, b) => new Date(b.createdAt?.toDate()) - new Date(a.createdAt?.toDate()));

                if (records.length > 0) {
                    const latestRecord = records[0];
                    const cargo = latestRecord.cargo || '';
                    const email = latestRecord.correo || '';
                    const phone = latestRecord.telefono || '';
                    
                    if (isEditModal) {
                        $('#edit-caller-cargo').val(cargo).trigger('change');
                        $('#edit-caller-email').val(email).trigger('change');
                        $('#edit-caller-phone').val(phone).trigger('change');
                    } else {
                        $('#caller-cargo').val(cargo).trigger('change');
                        $('#caller-email').val(email).trigger('change');
                        $('#caller-phone').val(phone).trigger('change');
                    }
                }
            }

            $('#caller-institution, #edit-caller-institution').on('change', function() {
                const institution = $(this).val();
                const isEditModal = $(this).attr('id').includes('edit');
                const nameSelect = isEditModal ? $('#edit-caller-name') : $('#caller-name');
                
                const allData = [...calls, ...historicalCalls];
                const namesForInstitution = [...new Set(allData
                    .filter(c => c.institucion === institution)
                    .map(c => c.nombre)
                    .filter(Boolean))].sort();
                
                nameSelect.empty().select2({
                    data: namesForInstitution,
                    tags: true,
                    placeholder: "Seleccione un nombre",
                    allowClear: true,
                    width: '100%'
                });

                // MEJORA: Si solo hay un nombre, seleccionarlo automáticamente y cargar sus datos
                if (namesForInstitution.length === 1) {
                    nameSelect.val(namesForInstitution[0]).trigger('change');
                    // Llamar directamente a la función para cargar los detalles
                    loadContactDetails(namesForInstitution[0], institution, isEditModal);
                } else {
                    // Limpiar campos dependientes solo si no hay un nombre único
                    if (isEditModal) {
                        $('#edit-caller-cargo, #edit-caller-email, #edit-caller-phone').val(null).trigger('change');
                    } else {
                        $('#caller-cargo, #caller-email, #caller-phone').val(null).trigger('change');
                    }
                }
            });

            // Evento change para el nombre
            $('#caller-name, #edit-caller-name').on('change', function() {
                const name = $(this).val();
                const isEditModal = $(this).attr('id').includes('edit');
                const institution = isEditModal ? $('#edit-caller-institution').val() : $('#caller-institution').val();
                loadContactDetails(name, institution, isEditModal);
            });
        }

        async function findAndReplaceInDatabase(field, oldValue, newValue) {
            const fieldToDbFieldMap = {
                'instituciones': 'institucion', 'areas': 'area', 'asuntos': 'asunto',
                'consultas': 'consulta', 'nombres': 'nombre', 'cargos': 'cargo',
                'correos': 'correo', 'telefonos': 'telefono', 'comentarios': 'comentarios',
                'atendioUsers': 'atendio'
            };
            
            const dbField = fieldToDbFieldMap[field];
            if (!dbField) return;
            
            try {
                const batch = writeBatch(db);
                const callsQuery = query(callsCollectionRef, where(dbField, '==', oldValue));
                const callsSnapshot = await getDocs(callsQuery);
                callsSnapshot.forEach(doc => batch.update(doc.ref, { [dbField]: newValue }));
                
                const historicalQuery = query(historicalCallsCollectionRef, where(dbField, '==', oldValue));
                const historicalSnapshot = await getDocs(historicalQuery);
                historicalSnapshot.forEach(doc => batch.update(doc.ref, { [dbField]: newValue }));
                
                await batch.commit();
                showAlert(`Se actualizaron ${callsSnapshot.size + historicalSnapshot.size} registros.`, "success");
            } catch (error) {
                console.error("Error al actualizar registros:", error);
                showAlert("Error al actualizar registros existentes", "error");
            }
        }

        function setupAddEditButtons() {
            const buttonMap = {
                'institution': 'instituciones', 'area': 'areas', 'subject': 'asuntos',
                'query': 'consultas', 'name': 'nombres', 'cargo': 'cargos',
                'email': 'correos', 'phone': 'telefonos', 'comments': 'comentarios',
                'atendio': 'atendioUsers'
            };

            document.body.addEventListener('click', (e) => {
                const button = e.target.closest('button.add-btn, button.edit-btn');
                if (!button) return;

                const idParts = button.id.split('-');
                const action = idParts[0]; // add or edit
                const fieldKey = idParts[1]; // institution, area, etc.
                const field = buttonMap[fieldKey];

                if (action === 'add') {
                    currentEditingField = field;
                    newOptionInput.value = '';
                    newOptionInput.placeholder = `Ingrese nueva opción para ${field}`;
                    openModal(addOptionModal);
                } else if (action === 'edit') {
                    const select = button.parentElement.querySelector('select');
                    const currentValue = $(select).val();
                    if (!currentValue) {
                        return showAlert("Por favor, seleccione una opción para editar.", "warning");
                    }
                    currentEditingField = field;
                    currentEditingValue = currentValue;
                    editOptionInput.value = currentValue;
                    editOptionInput.placeholder = `Edite la opción para ${field}`;
                    openModal(editOptionModal);
                }
            });
            
            confirmAddOptionBtn.addEventListener('click', () => {
                const newOption = newOptionInput.value.trim();
                if (newOption && currentEditingField) {
                    if (!fieldOptions[currentEditingField].includes(newOption)) {
                        fieldOptions[currentEditingField].push(newOption);
                        fieldOptions[currentEditingField].sort();
                        updateSelectOptions(currentEditingField, fieldOptions[currentEditingField]);
                        // Seleccionar la nueva opción automáticamente
                        $(`#${currentEditingField === 'instituciones' ? 'caller-institution' : 
                            currentEditingField === 'areas' ? 'call-area' :
                            currentEditingField === 'asuntos' ? 'call-subject' :
                            currentEditingField === 'consultas' ? 'call-query' :
                            currentEditingField === 'nombres' ? 'caller-name' :
                            currentEditingField === 'cargos' ? 'caller-cargo' :
                            currentEditingField === 'correos' ? 'caller-email' :
                            currentEditingField === 'telefonos' ? 'caller-phone' :
                            currentEditingField === 'comentarios' ? 'call-comments' :
                            'call-atendio'}`).val(newOption).trigger('change');
                    }
                    showAlert(`Opción "${newOption}" añadida.`, "success");
                    closeModal(addOptionModal);
                }
            });
            
            confirmEditOptionBtn.addEventListener('click', () => {
                const newValue = editOptionInput.value.trim();
                if (newValue && currentEditingField && currentEditingValue) {
                    requirePassword(() => {
                        findAndReplaceInDatabase(currentEditingField, currentEditingValue, newValue);
                        // Actualizar la opción en el select correspondiente
                        updateSelectOptions(currentEditingField, fieldOptions[currentEditingField]);
                        // Seleccionar la opción editada
                        $(`#${currentEditingField === 'instituciones' ? 'caller-institution' : 
                            currentEditingField === 'areas' ? 'call-area' :
                            currentEditingField === 'asuntos' ? 'call-subject' :
                            currentEditingField === 'consultas' ? 'call-query' :
                            currentEditingField === 'nombres' ? 'caller-name' :
                            currentEditingField === 'cargos' ? 'caller-cargo' :
                            currentEditingField === 'correos' ? 'caller-email' :
                            currentEditingField === 'telefonos' ? 'caller-phone' :
                            currentEditingField === 'comentarios' ? 'call-comments' :
                            'call-atendio'}`).val(newValue).trigger('change');
                        closeModal(editOptionModal);
                    });
                }
            });
            
            cancelAddOptionBtn.addEventListener('click', () => closeModal(addOptionModal));
            cancelEditOptionBtn.addEventListener('click', () => closeModal(editOptionModal));
            
            // MEJORA: Permitir activar con tecla Enter
            newOptionInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmAddOptionBtn.click();
                }
            });
            
            editOptionInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmEditOptionBtn.click();
                }
            });
        }

        // =============================================
        // MÓDULO: Autenticación y seguridad
        // =============================================
        
        function verifyPassword() {
            const password = passwordInput.value;
            if (password === 'admin') {
                closeModal(passwordModal);
                passwordInput.value = '';
                if (pendingAction) {
                    pendingAction();
                    pendingAction = null;
                }
            } else {
                showAlert("Contraseña incorrecta", "error");
                passwordInput.value = '';
            }
        }

        function setupPasswordVerification() {
            confirmPasswordBtn.addEventListener('click', verifyPassword);
            cancelPasswordBtn.addEventListener('click', () => {
                closeModal(passwordModal);
                pendingAction = null;
            });
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    verifyPassword();
                }
            });
        }

        function requirePassword(action) {
            pendingAction = action;
            openModal(passwordModal);
        }

        async function initializeAppWithAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userInfo.textContent = `Usuario Anónimo: ${userId.substring(0, 8)}...`;
                    setupRealtimeListeners();
                    showApp();
                } else {
                    await signInAnonymously(auth);
                }
            });
        }
        
        function setupRealtimeListeners() {
            onSnapshot(query(callsCollectionRef), (snapshot) => {
                calls = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortAndRenderTable(callLogTableBody, calls, false);
                updateDashboard();
                updateCharts();
                updateDynamicSelectOptions();
            }, (error) => console.error("Error en listener de llamadas:", error));
            
            onSnapshot(query(historicalCallsCollectionRef), (snapshot) => {
                historicalCalls = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortAndRenderTable(historicalTableBody, historicalCalls, true);
                updateDashboard();
                updateCharts();
                updateDynamicSelectOptions();
            }, (error) => console.error("Error en listener de histórico:", error));
        }

        // =============================================
        // MÓDULO: Gráficos y reportes
        // =============================================
        
        function updateCharts() {
            const source = reportesDataSource.value;
            let data = [];
            if (source === 'registro') data = calls;
            else if (source === 'historico') data = historicalCalls;
            else data = [...calls, ...historicalCalls];
            
            if (reportFilter.type === 'period' && reportFilter.startDate && reportFilter.endDate) {
                const startDate = new Date(reportFilter.startDate);
                let endDate = new Date(reportFilter.endDate);
                endDate.setHours(23, 59, 59, 999);
                data = data.filter(call => {
                    if (!call.fecha) return false;
                    try {
                        const callDate = new Date(call.fecha.split('/').reverse().join('-'));
                        return callDate >= startDate && callDate <= endDate;
                    } catch (e) { return false; }
                });
            }
            
            const chartWrappers = document.querySelectorAll('.chart-wrapper');
            const chartSize = chartSizeSlider.value;
            chartWrappers.forEach(wrapper => {
                wrapper.style.height = `${chartSize}px`;
            });

            const statusCounts = {}, asuntoCounts = {}, dayOfWeekCounts = {}, atendioCounts = {};
            data.forEach(call => {
                statusCounts[call.estatus || 'N/A'] = (statusCounts[call.estatus || 'N/A'] || 0) + 1;
                asuntoCounts[call.asunto || 'N/A'] = (asuntoCounts[call.asunto || 'N/A'] || 0) + 1;
                atendioCounts[call.atendio || 'N/A'] = (atendioCounts[call.atendio || 'N/A'] || 0) + 1;
                if (call.fecha && typeof call.fecha === 'string') {
                    try {
                        const date = new Date(call.fecha.split('/').reverse().join('-'));
                        const day = date.toLocaleDateString('es-ES', { weekday: 'long' });
                        dayOfWeekCounts[day] = (dayOfWeekCounts[day] || 0) + 1;
                    } catch (e) { /* Ignorar */ }
                }
            });
            
            const createOrUpdateChart = (canvas, chartInstance, type, data, labelsOrder) => {
                if (chartInstance) chartInstance.destroy();
                let labels = Object.keys(data);
                if (labelsOrder) labels.sort((a, b) => labelsOrder.indexOf(a) - labelsOrder.indexOf(b));
                const chartData = labels.map(label => data[label]);
                
                return new Chart(canvas, { 
                    type, 
                    data: { labels, datasets: [{ data: chartData, backgroundColor: ['#9C2348', '#1E5B4F', '#A6802D', '#EF4444', '#3B82F6'] }] }, 
                    options: { responsive: true, maintainAspectRatio: false } 
                });
            };

            statusChart = createOrUpdateChart(statusChartCanvas, statusChart, 'pie', statusCounts);
            asuntoChart = createOrUpdateChart(asuntoChartCanvas, asuntoChart, 'bar', asuntoCounts);
            atendioChart = createOrUpdateChart(atendioChartCanvas, atendioChart, 'polarArea', atendioCounts);
            dayOfWeekChart = createOrUpdateChart(dayOfWeekChartCanvas, dayOfWeekChart, 'line', dayOfWeekCounts, ['lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado', 'domingo']);

            // Actualizar gráfica dinámica
            updateDynamicChart();

            $.pivotUtilities.locales.es = {
                localeStrings: { renderError: "Error al renderizar.", computeError: "Error al calcular.", uiRenderError: "Error de UI.", selectAll: "Seleccionar Todo", selectNone: "Seleccionar Ninguno", tooMany: "(demasiados)", filterResults: "Filtrar", apply: "Aplicar", cancel: "Cancelar", totals: "Totales", vs: "vs", by: "por" },
                aggregators: { "Conteo": "Conteo", "Suma": "Suma", "Promedio": "Promedio", "Mínimo": "Mínimo", "Máximo": "Máximo" },
                renderers: { "Tabla": "Tabla", "Gráfico de Barras": "Gráfico de Barras", "Gráfico de Líneas": "Gráfico de Líneas", "Mapa de Calor": "Mapa de Calor" }
            };

            $(pivotTableContainer).pivotUI(data, {
                rows: ["area"], cols: ["estatus"], vals: ["duracion"],
                aggregatorName: "Conteo", rendererName: "Tabla", locale: "es"
            });
        }

        function updateDynamicChart() {
            const source = reportesDataSource.value;
            let data = [];
            if (source === 'registro') data = calls;
            else if (source === 'historico') data = historicalCalls;
            else data = [...calls, ...historicalCalls];
            
            if (reportFilter.type === 'period' && reportFilter.startDate && reportFilter.endDate) {
                const startDate = new Date(reportFilter.startDate);
                let endDate = new Date(reportFilter.endDate);
                endDate.setHours(23, 59, 59, 999);
                data = data.filter(call => {
                    if (!call.fecha) return false;
                    try {
                        const callDate = new Date(call.fecha.split('/').reverse().join('-'));
                        return callDate >= startDate && callDate <= endDate;
                    } catch (e) { return false; }
                });
            }
            
            const selectedVariable = dynamicChartVariable.value;
            const variableCounts = {};
            const variableStatusCounts = {};
            
            data.forEach(call => {
                const value = call[selectedVariable] || 'N/A';
                variableCounts[value] = (variableCounts[value] || 0) + 1;
                
                if (!variableStatusCounts[value]) {
                    variableStatusCounts[value] = { 'Atendida': 0, 'Pendiente': 0 };
                }
                
                if (call.estatus === 'Atendida') {
                    variableStatusCounts[value].Atendida += 1;
                } else {
                    variableStatusCounts[value].Pendiente += 1;
                }
            });
            
            // Actualizar tabla dinámica
            dynamicTableBody.innerHTML = '';
            dynamicTableHeader.textContent = selectedVariable.charAt(0).toUpperCase() + selectedVariable.slice(1);
            
            Object.entries(variableStatusCounts).forEach(([value, counts]) => {
                const total = counts.Atendida + counts.Pendiente;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${value}</td>
                    <td>${counts.Atendida}</td>
                    <td>${counts.Pendiente}</td>
                    <td>${total}</td>
                `;
                dynamicTableBody.appendChild(row);
            });
            
            // Actualizar gráfico
            if (dynamicChart) dynamicChart.destroy();
            
            const labels = Object.keys(variableCounts);
            const chartData = Object.values(variableCounts);
            
            dynamicChart = new Chart(dynamicChartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad',
                        data: chartData,
                        backgroundColor: '#9C2348'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function setupReportConfig() {
            configReportBtn.addEventListener('click', () => openModal(configReportModal));
            closeConfigReportModalBtn.addEventListener('click', () => closeModal(configReportModal));
            
            filterAllDataRadio.addEventListener('change', () => {
                configReportStartDate.disabled = true;
                configReportEndDate.disabled = true;
            });
            
            filterByPeriodRadio.addEventListener('change', () => {
                configReportStartDate.disabled = false;
                configReportEndDate.disabled = false;
            });
            
            saveConfigReportBtn.addEventListener('click', () => {
                if (filterByPeriodRadio.checked && (!configReportStartDate.value || !configReportEndDate.value)) {
                    return showAlert("Por favor, seleccione un rango de fechas válido.", "warning");
                }
                reportFilter.type = filterAllDataRadio.checked ? 'all' : 'period';
                reportFilter.startDate = configReportStartDate.value;
                reportFilter.endDate = configReportEndDate.value;
                
                showAlert("Configuración de reportes guardada.", "success");
                closeModal(configReportModal);
                updateCharts();
            });
        }

        function generateExecutiveReport(includeStatus, includeAsunto, includeDay, includeAtendio, includeDynamic) {
            const source = reportesDataSource.value;
            let data = [];
            if (source === 'registro') data = calls;
            else if (source === 'historico') data = historicalCalls;
            else data = [...calls, ...historicalCalls];
            
            if (reportFilter.type === 'period' && reportFilter.startDate && reportFilter.endDate) {
                const startDate = new Date(reportFilter.startDate);
                let endDate = new Date(reportFilter.endDate);
                endDate.setHours(23, 59, 59, 999);
                data = data.filter(call => {
                    if (!call.fecha) return false;
                    try {
                        const callDate = new Date(call.fecha.split('/').reverse().join('-'));
                        return callDate >= startDate && callDate <= endDate;
                    } catch (e) { return false; }
                });
            }
            
            const statusCounts = {}, asuntoCounts = {}, dayOfWeekCounts = {}, atendioCounts = {};
            data.forEach(call => {
                statusCounts[call.estatus || 'N/A'] = (statusCounts[call.estatus || 'N/A'] || 0) + 1;
                asuntoCounts[call.asunto || 'N/A'] = (asuntoCounts[call.asunto || 'N/A'] || 0) + 1;
                atendioCounts[call.atendio || 'N/A'] = (atendioCounts[call.atendio || 'N/A'] || 0) + 1;
                if (call.fecha && typeof call.fecha === 'string') {
                    try {
                        const date = new Date(call.fecha.split('/').reverse().join('-'));
                        const day = date.toLocaleDateString('es-ES', { weekday: 'long' });
                        dayOfWeekCounts[day] = (dayOfWeekCounts[day] || 0) + 1;
                    } catch (e) { /* Ignorar */ }
                }
            });
            
            const totalCalls = data.length;
            const atendidas = data.filter(c => c.estatus === 'Atendida').length;
            const pendientes = totalCalls - atendidas;
            const totalDuration = data.reduce((sum, c) => sum + (Number(c.duracion) || 0), 0);
            const avgDuration = totalCalls > 0 ? Math.round(totalDuration / totalCalls) : 0;
            
            const currentDate = new Date().toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            let reportHTML = `
                <div class="reporte-ejecutivo">
                    <div class="reporte-header">
                        <h1>Reporte Ejecutivo de Llamadas</h1>
                        <p>Generado el: ${currentDate}</p>
                        <p>Total de registros: ${totalCalls}</p>
                    </div>
                    
                    <div class="reporte-metricas">
                        <div class="metrica">
                            <h3>Llamadas Atendidas</h3>
                            <p>${atendidas}</p>
                        </div>
                        <div class="metrica">
                            <h3>Llamadas Pendientes</h3>
                            <p>${pendientes}</p>
                        </div>
                        <div class="metrica">
                            <h3>Duración Promedio</h3>
                            <p>${formatDuration(avgDuration)}</p>
                        </div>
                        <div class="metrica">
                            <h3>Total de Llamadas</h3>
                            <p>${totalCalls}</p>
                        </div>
                    </div>
            `;
            
            if (includeStatus) {
                reportHTML += `
                    <div class="grafica">
                        <h3>Llamadas por Estatus</h3>
                        <canvas id="report-status-chart" width="400" height="300"></canvas>
                    </div>
                `;
            }
            
            if (includeAsunto) {
                reportHTML += `
                    <div class="grafica">
                        <h3>Llamadas por Asunto</h3>
                        <canvas id="report-asunto-chart" width="400" height="300"></canvas>
                    </div>
                `;
            }
            
            if (includeDay) {
                reportHTML += `
                    <div class="grafica">
                        <h3>Llamadas por Día de la Semana</h3>
                        <canvas id="report-day-chart" width="400" height="300"></canvas>
                    </div>
                `;
            }
            
            if (includeAtendio) {
                reportHTML += `
                    <div class="grafica">
                        <h3>Llamadas por Servidor Público</h3>
                        <canvas id="report-atendio-chart" width="400" height="300"></canvas>
                    </div>
                `;
            }
            
            if (includeDynamic) {
                const selectedVariable = dynamicChartVariable.value;
                const variableCounts = {};
                const variableStatusCounts = {};
                
                data.forEach(call => {
                    const value = call[selectedVariable] || 'N/A';
                    variableCounts[value] = (variableCounts[value] || 0) + 1;
                    
                    if (!variableStatusCounts[value]) {
                        variableStatusCounts[value] = { 'Atendida': 0, 'Pendiente': 0 };
                    }
                    
                    if (call.estatus === 'Atendida') {
                        variableStatusCounts[value].Atendida += 1;
                    } else {
                        variableStatusCounts[value].Pendiente += 1;
                    }
                });
                
                reportHTML += `
                    <div class="grafica">
                        <h3>Llamadas por ${selectedVariable.charAt(0).toUpperCase() + selectedVariable.slice(1)}</h3>
                        <canvas id="report-dynamic-chart" width="400" height="300"></canvas>
                    </div>
                    <div class="tabla-datos">
                        <h3>Distribución por Estatus - ${selectedVariable.charAt(0).toUpperCase() + selectedVariable.slice(1)}</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>${selectedVariable.charAt(0).toUpperCase() + selectedVariable.slice(1)}</th>
                                    <th>Atendida</th>
                                    <th>Pendiente</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                Object.entries(variableStatusCounts).forEach(([value, counts]) => {
                    const total = counts.Atendida + counts.Pendiente;
                    reportHTML += `
                        <tr>
                            <td>${value}</td>
                            <td>${counts.Atendida}</td>
                            <td>${counts.Pendiente}</td>
                            <td>${total}</td>
                        </tr>
                    `;
                });
                
                reportHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            reportHTML += `
                    <div class="reporte-footer">
                        <p>Sistema de Registro de Llamadas v1.3 - Gobierno de México</p>
                    </div>
                </div>
            `;
            
            reportPreview.innerHTML = reportHTML;
            
            // Generar gráficos para el reporte
            setTimeout(() => {
                if (includeStatus) {
                    new Chart(document.getElementById('report-status-chart'), {
                        type: 'pie',
                        data: {
                            labels: Object.keys(statusCounts),
                            datasets: [{
                                data: Object.values(statusCounts),
                                backgroundColor: ['#9C2348', '#1E5B4F', '#A6802D', '#EF4444', '#3B82F6']
                            }]
                        }
                    });
                }
                
                if (includeAsunto) {
                    new Chart(document.getElementById('report-asunto-chart'), {
                        type: 'bar',
                        data: {
                            labels: Object.keys(asuntoCounts),
                            datasets: [{
                                label: 'Cantidad',
                                data: Object.values(asuntoCounts),
                                backgroundColor: '#9C2348'
                            }]
                        }
                    });
                }
                
                if (includeDay) {
                    const daysOrder = ['lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado', 'domingo'];
                    const orderedData = daysOrder.map(day => dayOfWeekCounts[day] || 0);
                    
                    new Chart(document.getElementById('report-day-chart'), {
                        type: 'line',
                        data: {
                            labels: daysOrder,
                            datasets: [{
                                label: 'Llamadas',
                                data: orderedData,
                                borderColor: '#9C2348',
                                tension: 0.1
                            }]
                        }
                    });
                }
                
                if (includeAtendio) {
                    new Chart(document.getElementById('report-atendio-chart'), {
                        type: 'polarArea',
                        data: {
                            labels: Object.keys(atendioCounts),
                            datasets: [{
                                data: Object.values(atendioCounts),
                                backgroundColor: ['#9C2348', '#1E5B4F', '#A6802D', '#EF4444', '#3B82F6']
                            }]
                        }
                    });
                }
                
                if (includeDynamic) {
                    const selectedVariable = dynamicChartVariable.value;
                    const variableCounts = {};
                    
                    data.forEach(call => {
                        const value = call[selectedVariable] || 'N/A';
                        variableCounts[value] = (variableCounts[value] || 0) + 1;
                    });
                    
                    new Chart(document.getElementById('report-dynamic-chart'), {
                        type: 'bar',
                        data: {
                            labels: Object.keys(variableCounts),
                            datasets: [{
                                label: 'Cantidad',
                                data: Object.values(variableCounts),
                                backgroundColor: '#9C2348'
                            }]
                        }
                    });
                }
                
                // Generar PDF
                const element = reportPreview;
                const opt = {
                    margin: 10,
                    filename: `reporte_llamadas_${new Date().toISOString().slice(0, 10)}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                // Usar html2pdf con promesas para asegurar que se complete la generación
                html2pdf().set(opt).from(element).save().then(() => {
                    showAlert("Reporte generado y descargado con éxito", "success");
                }).catch(error => {
                    console.error("Error al generar PDF:", error);
                    showAlert("Error al generar el PDF: " + error.message, "error");
                });
            }, 500);
        }

        // =============================================
        // MÓDULO: Exportación/Importación
        // =============================================
        
        const exportHeaders = ["No.", "Fecha", "Inicio", "Fin", "Duración", "Área", "Institución", "Asunto", "Consulta", "Nombre", "Cargo", "Correo", "Teléfono", "Estatus", "Atendió", "Comentarios"];

        function prepareExportData(data) {
            return data.map((call, index) => ({
                "No.": index + 1, "Fecha": call.fecha || "", "Inicio": formatTimeWithAmPm(call.inicio),
                "Fin": formatTimeWithAmPm(call.fin), "Duración": formatDuration(Number(call.duracion) || 0),
                "Área": call.area || "", "Institución": call.institucion || "", "Asunto": call.asunto || "",
                "Consulta": call.consulta || "", "Nombre": call.nombre || "", "Cargo": call.cargo || "",
                "Correo": call.correo || "", "Teléfono": String(call.telefono || ""), "Estatus": call.estatus || "",
                "Atendió": call.atendio || "", "Comentarios": call.comentarios || ""
            }));
        }

        // =============================================
        // MÓDULO: Migración de datos
        // =============================================
        
        async function migrateCallsToHistorical() {
            try {
                if (calls.length === 0) {
                    showAlert("No hay llamadas para migrar.", "warning");
                    return;
                }
                
                const batch = writeBatch(db);
                
                // Agregar todas las llamadas al histórico
                calls.forEach(call => {
                    const historicalDocRef = doc(historicalCallsCollectionRef);
                    batch.set(historicalDocRef, { 
                        ...call, 
                        migratedAt: serverTimestamp(),
                        originalId: call.id
                    });
                });
                
                // Eliminar todas las llamadas del registro actual
                calls.forEach(call => {
                    const callDocRef = doc(callsCollectionRef, call.id);
                    batch.delete(callDocRef);
                });
                
                await batch.commit();
                showAlert(`Se migraron ${calls.length} llamadas al histórico.`, "success");
            } catch (error) {
                console.error("Error al migrar llamadas:", error);
                showAlert(`Error al migrar: ${error.message}`, "error");
            }
        }

        // =============================================
        // MÓDULO: Configuración de eventos
        // =============================================
        
        function setupEventListeners() {
            setupTabs();
            setupSorting('main-table-header', callLogTableBody, () => calls, renderTable);
            setupSorting('historical-table-header', historicalTableBody, () => historicalCalls, renderTable);
            setupFiltering('filter-input-main', callLogTableBody, () => calls, renderTable, false);
            setupFiltering('filter-input-historical', historicalTableBody, () => historicalCalls, renderTable, true);
            setupAutofill();
            
            dashboardDataSource.addEventListener('change', updateDashboard);
            reportesDataSource.addEventListener('change', updateCharts);
            dynamicChartVariable.addEventListener('change', updateDynamicChart);
            
            startCallBtn.addEventListener('click', () => {
                startCallBtn.dataset.state === 'active' ? (stopTimer(false), closeModal(callModal)) : startTimer();
            });
            
            closeModalBtn.addEventListener('click', () => {
                closeModal(callModal);
                if (startCallBtn.dataset.state === 'active') stopTimer(false);
            });
            
            callForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!callForm.checkValidity()) return showAlert("Por favor, complete todos los campos obligatorios.", "warning");
                stopTimer();
                closeModal(callModal);
            });
            
            closeEditModalBtn.addEventListener('click', () => closeModal(editModal));
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!editForm.checkValidity()) return showAlert("Por favor, complete todos los campos obligatorios.", "warning");
                
                const formData = new FormData(editForm);
                const updateData = Object.fromEntries(formData.entries());
                const id = document.getElementById('edit-id').value;
                
                await updateCall(id, updateData, currentEditIsHistorical);
                closeModal(editModal);
            });
            
            document.body.addEventListener('click', (e) => {
                if (e.target.matches('.toggle-status-btn')) handleStatusToggle(e);
                else if (e.target.matches('.edit-btn') || e.target.closest('.edit-btn')) handleEditClick(e);
                else if (e.target.matches('.delete-btn') || e.target.closest('.delete-btn')) handleDeleteClick(e);
            });
            
            let callToDeleteId, callToDeleteIsHistorical;
            cancelDeleteBtn.addEventListener('click', () => closeModal(confirmModal));
            confirmDeleteBtn.addEventListener('click', async () => {
                await deleteCall(callToDeleteId, callToDeleteIsHistorical);
                closeModal(confirmModal);
            });
            
            historicalFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    historicalFileName.textContent = file.name;
                    importHistoricalBtn.disabled = false;
                } else {
                    historicalFileName.textContent = 'Seleccionar archivo Excel (.xlsx)';
                    importHistoricalBtn.disabled = true;
                }
            });
            
            importHistoricalBtn.addEventListener('click', () => {
                const file = historicalFileInput.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        if (jsonData.length === 0) return showAlert("El archivo no contiene datos válidos.", "warning");
                        
                        const historicalData = jsonData.map(item => ({
                            fecha: item.Fecha || '',
                            inicio: item.Inicio || '',
                            fin: item.Fin || '',
                            duracion: typeof item.Duración === 'number' ? item.Duración : 0,
                            area: item.Área || '',
                            institucion: item.Institución || '',
                            asunto: item.Asunto || '',
                            consulta: item.Consulta || '',
                            nombre: item.Nombre || '',
                            cargo: item.Cargo || '',
                            correo: item.Correo || '',
                            telefono: item.Teléfono ? String(item.Teléfono) : '',
                            estatus: item.Estatus || '',
                            atendio: item.Atendió || '',
                            comentarios: item.Comentarios || ''
                        }));
                        
                        if (historicalCalls.length > 0) {
                            openModal(replaceHistoricalModal);
                            confirmReplaceBtn.onclick = async () => {
                                await deleteAllHistorical();
                                await importHistoricalData(historicalData);
                                closeModal(replaceHistoricalModal);
                            };
                            cancelReplaceBtn.onclick = () => closeModal(replaceHistoricalModal);
                        } else {
                            importHistoricalData(historicalData);
                        }
                    } catch (error) {
                        console.error("Error al procesar el archivo:", error);
                        showAlert("Error al procesar el archivo. Asegúrese de que es un Excel válido.", "error");
                    }
                };
                reader.readAsArrayBuffer(file);
            });
            
            downloadExcelBtn.addEventListener('click', () => {
                const data = prepareExportData(calls);
                const ws = XLSX.utils.json_to_sheet(data, { header: exportHeaders });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Llamadas");
                XLSX.writeFile(wb, "registro_llamadas.xlsx");
            });
            
            document.getElementById('download-historical-excel-btn').addEventListener('click', () => {
                const data = prepareExportData(historicalCalls);
                const ws = XLSX.utils.json_to_sheet(data, { header: exportHeaders });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Llamadas Históricas");
                XLSX.writeFile(wb, "historico_llamadas.xlsx");
            });
            
            generateReportBtn.addEventListener('click', () => openModal(reportModal));
            closeReportModalBtn.addEventListener('click', () => closeModal(reportModal));
            
            generatePdfBtn.addEventListener('click', () => {
                const includeStatus = document.getElementById('include-status').checked;
                const includeAsunto = document.getElementById('include-asunto').checked;
                const includeDay = document.getElementById('include-day').checked;
                const includeAtendio = document.getElementById('include-atendio').checked;
                const includeDynamic = document.getElementById('include-dynamic').checked;
                
                closeModal(reportModal);
                generateExecutiveReport(includeStatus, includeAsunto, includeDay, includeAtendio, includeDynamic);
            });
            
            chartSizeSlider.addEventListener('input', () => {
                const size = chartSizeSlider.value;
                chartSizeValue.textContent = `${size}px`;
                updateCharts();
            });
            
            migrateCallsBtn.addEventListener('click', () => {
                requirePassword(() => openModal(migrateModal));
            });
            
            cancelMigrateBtn.addEventListener('click', () => closeModal(migrateModal));
            confirmMigrateBtn.addEventListener('click', () => {
                migrateCallsToHistorical();
                closeModal(migrateModal);
            });
        }

        // =============================================
        // MÓDULO: Inicialización
        // =============================================
        
        function initialize() {
            initializeAppWithAuth();
            setupEventListeners();
            setupAddEditButtons();
            setupPasswordVerification();
            setupReportConfig();
            
            // Configurar Select2 para todos los selects
            $('#call-form select, #edit-form select').each(function() {
                $(this).select2({
                    tags: true,
                    placeholder: "Seleccione o escriba una opción",
                    allowClear: true,
                    width: '100%'
                });
            });
        }

        // Iniciar la aplicación
        initialize();
    </script>
</body>
</html>
