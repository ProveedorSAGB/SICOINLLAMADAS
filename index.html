<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Llamadas v1.0</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- js-xlsx para leer archivos de Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- PivotTable.js para tabla dinámica interactiva -->
    <link rel="stylesheet" type="text/css" href="https://pivottable.js.org/dist/pivot.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://pivottable.js.org/dist/pivot.min.js"></script>
    
    <!-- Select2 for searchable dropdown -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- Hoja de estilos personalizada -->
    <style>
        html { font-size: 75%; } /* Simula zoom negativo al 75% */
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .bg-gob-maroon { background-color: #6A002C; }
        .text-gob-maroon { color: #6A002C; }
        .border-gob-maroon { border-color: #6A002C; }
        .focus\:ring-gob-maroon:focus { --tw-ring-color: #6A002C; }
        .bg-subtle-green { background-color: #10B981; }
        .hover\:bg-subtle-green-dark:hover { background-color: #059669; }
        .bg-subtle-red { background-color: #EF4444; }
        .hover\:bg-subtle-red-dark:hover { background-color: #DC2626; }
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .hidden { display: none; }
        .tab-btn.active { border-color: #6A002C; color: #6A002C; font-weight: bold; }
        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #6A002C; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .table-container { overflow-x: auto; }
        .status-button {
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem;
            line-height: 1.25rem; font-weight: 500; text-align: center; user-select: none; border: 1px solid transparent;
        }
        .status-atendida { background-color: #10B981; color: #fff; border-color: #059669; }
        .status-pendiente { background-color: #EF4444; color: #fff; border-color: #DC2626; }
        .sortable-header { cursor: pointer; }
        .sortable-header .sort-icon { display: none; }
        .sortable-header.asc .sort-icon.asc,
        .sortable-header.desc .sort-icon.desc { display: inline-block; }
        input:invalid, select:invalid { border-color: #ef4444; }
        .section-title { font-weight: bold; color: #6A002C; margin-bottom: 1rem; }
        header + div { top: 56px !important; } /* Ajuste para eliminar hueco entre header y tabs */

        .flex-with-button {
            display: flex;
            align-items: flex-end;
        }

        .flex-with-button .select2-container {
            flex-grow: 1;
            margin-right: 0.5rem;
            margin-bottom: 1px; /* Alineación vertical */
        }

        .flex-with-button button {
            height: 38px;
            margin-bottom: 1px; /* Alineación vertical */
            flex-shrink: 0;
            background-color: #3b82f6; /* Azul */
            color: white;
            border-radius: 0.25rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }

        .flex-with-button button:hover {
            background-color: #2563eb; /* Azul más oscuro al pasar el mouse */
        }

    </style>
</head>
<body class="antialiased text-slate-700">

    <div id="loader" class="loader">
        <div class="spinner"></div>
        <p class="mt-4 text-sm text-slate-600">Cargando datos, por favor espera...</p>
    </div>

    <div id="app" class="min-h-screen hidden">
        <header class="bg-gob-maroon shadow-lg sticky top-0 z-10">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <svg class="h-14 w-auto" fill="#FFFFFF" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                    <h1 class="text-xl sm:text-2xl font-bold text-white tracking-tight">Registro de Contacto y Llamadas v1.0</h1>
                </div>
                <div id="user-info" class="text-white text-sm font-mono"></div>
            </div>
        </header>

        <div class="bg-white shadow-sm sticky top-[56px] z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="tabs" class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button data-tab="registro" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Registro y Control</button>
                        <button data-tab="historico" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Histórico</button>
                        <button data-tab="reportes" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Reportes y Gráficos</button>
                    </nav>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <main id="tab-content-registro" class="tab-content">
                <section id="dashboard" class="mb-8">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gob-maroon mb-2 sm:mb-0">Dashboard General</h2>
                        <div class="flex items-center space-x-4">
                            <label for="dashboard-data-source" class="block text-sm font-medium text-gray-700">Fuente de datos:</label>
                            <select id="dashboard-data-source" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2">
                                <option value="registro">Registro y Control</option>
                                <option value="historico">Histórico</option>
                                <option value="combinado">Registro y Control + Histórico</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4"><div class="bg-gob-maroon/10 p-3 rounded-full"><i class="fa-solid fa-phone-volume text-gob-maroon text-2xl"></i></div><div><p class="text-slate-500">Total de Llamadas</p><p id="total-calls" class="text-3xl font-bold text-gob-maroon">0</p></div></div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4"><div class="bg-gob-maroon/10 p-3 rounded-full"><i class="fa-solid fa-hourglass-half text-gob-maroon text-2xl"></i></div><div><p class="text-slate-500">Duración Promedio</p><p id="avg-duration" class="text-3xl font-bold text-gob-maroon">00:00</p></div></div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4"><div class="bg-subtle-green/10 p-3 rounded-full"><i class="fa-solid fa-circle-check text-subtle-green text-2xl"></i></div><div><p class="text-slate-500">Llamadas Atendidas</p><p id="atendidas-count" class="text-3xl font-bold text-subtle-green">0</p></div></div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4"><div class="bg-subtle-red/10 p-3 rounded-full"><i class="fa-solid fa-circle-xmark text-subtle-red text-2xl"></i></div><div><p class="text-slate-500">Llamadas Pendientes</p><p id="pendientes-count" class="text-3xl font-bold text-subtle-red">0</p></div></div>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-xl shadow-md mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="text-center md:text-left"><h3 class="text-xl font-semibold text-slate-800">Control de Llamadas</h3><p class="text-slate-500">Inicia una nueva llamada para activar el cronómetro y el formulario.</p></div>
                    <div class="flex items-center gap-6"><div class="text-center"><p class="text-sm font-medium text-slate-500">TIEMPO DE LLAMADA ACTUAL</p><p id="timer" class="text-4xl font-bold text-gob-maroon tracking-wider">00:00:00</p></div><button id="start-call-btn" class="bg-subtle-green hover:bg-subtle-green-dark text-white font-bold py-4 px-8 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out flex items-center space-x-3"><i class="fa-solid fa-phone-alt h-6 w-6"></i><span>Iniciar Nueva Llamada</span></button></div>
                </section>
                
                <section id="call-log">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gob-maroon">Historial de Llamadas</h2><div class="flex items-center space-x-2"><div class="relative w-full"><input type="text" id="filter-input-main" placeholder="Buscar..." class="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gob-maroon"><i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i><button id="clear-filter-btn-main" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden"><i class="fa-solid fa-times-circle"></i></button></div><button id="download-excel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2"><i class="fa-solid fa-file-excel"></i><span>Descargar Excel</span></button></div></div>
                    <div class="bg-white rounded-xl shadow-md table-container">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr id="main-table-header">
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="no">No. <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="fecha">Fecha <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="inicio">Inicio <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="fin">Fin <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="duracion">Duración <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="area">Área <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="institucion">Institución <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="asunto">Asunto <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="consulta">Consulta <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="nombre">Nombre <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="cargo">Cargo <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="correo">Correo <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="telefono">Teléfono <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="estatus">Estatus <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="atendio">Atendió <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="comentarios">Comentarios <span class="sort-icon asc"><i class="fa-solid fa-caret-up"></i></span><span class="sort-icon desc"><i class="fa-solid fa-caret-down"></i></span></th>
                                    <th scope="col" class="py-3 px-6">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="calls-table-body"></tbody>
                        </table>
                        <div id="no-calls-message" class="p-6 text-center text-slate-500 hidden"><p>No hay llamadas registradas en la base de datos.</p></div>
                    </div>
                </section>
            </main>

            <div id="tab-content-historico" class="tab-content hidden">
                <section class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gob-maroon mb-4">Cargar Histórico desde Excel</h2>
                    <div class="flex flex-col md:flex-row items-center gap-4"><label for="historical-file-input" class="w-full md:w-auto cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 px-6 rounded-lg shadow-sm transition-all duration-200 ease-in-out text-center flex-grow"><i class="fa-solid fa-file-upload mr-2"></i><span id="file-name">Seleccionar archivo Excel (.xlsx)</span><input type="file" id="historical-file-input" class="hidden" accept=".xlsx, .xls"></label><button id="import-historical-btn" class="w-full md:w-auto bg-gob-maroon hover:bg-[#5a0025] text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled><i class="fa-solid fa-database mr-2"></i>Importar a la Base de Datos</button></div>
                </section>
                
                <section id="historical-log" class="mt-8">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gob-maroon">Registro Histórico</h2><div class="flex items-center space-x-2"><div class="relative w-full"><input type="text" id="filter-input-historical" placeholder="Buscar..." class="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gob-maroon"><i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i><button id="clear-filter-btn-historical" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden"><i class="fa-solid fa-times-circle"></i></button></div><button id="download-historical-excel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2"><i class="fa-solid fa-file-excel"></i><span>Descargar Histórico</span></button></div></div>
                    <div class="bg-white rounded-xl shadow-md table-container">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr id="historical-table-header">
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="no">No.</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="fecha">Fecha</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="inicio">Inicio</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="fin">Fin</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="duracion">Duración</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="area">Área</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="institucion">Institución</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="asunto">Asunto</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="consulta">Consulta</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="nombre">Nombre</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="cargo">Cargo</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="correo">Correo</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="telefono">Teléfono</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="estatus">Estatus</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="atendio">Atendió</th>
                                    <th scope="col" class="py-3 px-6 sortable-header" data-sort-by="comentarios">Comentarios</th>
                                    <th scope="col" class="py-3 px-6">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="historical-table-body"></tbody>
                        </table>
                        <div id="no-historical-message" class="p-6 text-center text-slate-500 hidden"><p>No hay datos históricos cargados.</p></div>
                    </div>
                </section>
            </div>

            <div id="tab-content-reportes" class="tab-content hidden">
                <section class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gob-maroon">Reportes</h2>
                        <div class="flex items-center space-x-4">
                            <label for="reportes-data-source" class="block text-sm font-medium text-gray-700">Fuente de datos:</label>
                            <select id="reportes-data-source" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2">
                                <option value="registro">Registro y Control</option>
                                <option value="historico">Histórico</option>
                                <option value="combinado">Registro y Control + Histórico</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div><h3 class="text-xl font-semibold text-slate-800 mb-2">Llamadas por Estatus</h3><canvas id="statusChart"></canvas></div>
                        <div><h3 class="text-xl font-semibold text-slate-800 mb-2">Llamadas por Área</h3><canvas id="areaChart"></canvas></div>
                        <div><h3 class="text-xl font-semibold text-slate-800 mb-2">Llamadas por Día de la Semana</h3><canvas id="dayOfWeekChart"></canvas></div>
                        <div><h3 class="text-xl font-semibold text-slate-800 mb-2">Llamadas por Institución</h3><canvas id="institutionChart"></canvas></div>
                    </div>
                </section>
                <section class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gob-maroon mb-4">Tabla Dinámica Interactiva</h2>
                    <p class="text-slate-500 mb-4">Selecciona variables para cruzar datos y genera gráficos dinámicos (tablas, barras, líneas, heatmaps, etc.).</p>
                    <div id="pivot-table"></div>
                </section>
            </div>
        </div>
    </div>
    
    <div id="call-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl mx-4">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fa-solid fa-times-circle fa-lg"></i></button>
            <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold text-gob-maroon">Detalles de la Llamada</h3><div class="text-right"><p class="text-sm font-medium text-slate-500">TIEMPO DE LLAMADA ACTUAL</p><p id="modal-timer" class="text-2xl font-bold text-gob-maroon tracking-wider">00:00:00</p></div></div>
            <form id="call-form" class="space-y-6" novalidate>
                <div> 
                    <h4 class="section-title text-lg">Datos Institución</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

                        <div class="flex-with-button">
                            <div class="flex-grow">
                                <label for="caller-institution">Institución</label>
                                <select id="caller-institution"></select>
                            </div>
                            <button id="add-institution-btn">+</button>
                        </div>

                        <div><label for="call-area" class="block text-sm font-medium text-gray-700">Área o Departamento</label><textarea id="call-area" name="area" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" required></textarea></div>
                        <div><label for="call-subject" class="block text-sm font-medium text-gray-700">Asunto</label><input type="text" id="call-subject" name="asunto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" required></div>
                        <div><label for="call-query" class="block text-sm font-medium text-gray-700">Consulta</label><input type="text" id="call-query" name="consulta" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" required></div>
                    </div>
                </div>
                <div>
                    <h4 class="section-title text-lg">Datos Personales</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label for="caller-name" class="block text-sm font-medium text-gray-700">Nombre del Solicitante</label><input type="text" id="caller-name" name="nombre" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" required></div>
                        <div><label for="caller-cargo" class="block text-sm font-medium text-gray-700">Cargo del Solicitante</label><input type="text" id="caller-cargo" name="cargo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" required></div>
                        <div><label for="caller-email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label><input type="email" id="caller-email" name="correo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" required></div>
                        <div>
                          <label for="caller-phone" class="block text-sm font-medium text-gray-700">Teléfono (opcional)</label>
                          <input type="text" id="caller-phone" name="telefono" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2">
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="section-title text-lg">Atendió y Comentarios</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="flex items-end">
                            <div class="flex-grow"><label for="call-atendio" class="block text-sm font-medium text-gray-700">Atendió</label><select id="call-atendio" name="atendio" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" required></select></div>
                            <button type="button" id="add-atendio-btn" class="ml-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <div><label for="call-comments" class="block text-sm font-medium text-gray-700">Comentarios</label><input type="text" id="call-comments" name="comentarios" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2"></div>
                    </div>
                </div>
                <div class="flex items-center justify-end pt-4"><button type="submit" class="bg-gob-maroon hover:bg-[#5a0025] text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar y Finalizar Llamada</button></div>
            </form>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl mx-4">
            <button id="close-edit-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fa-solid fa-times-circle fa-lg"></i></button>
            <h3 class="text-2xl font-bold text-gob-maroon mb-6">Editar Llamada</h3>
            <form id="edit-form" class="space-y-6" novalidate>
                <input type="hidden" id="edit-id">
                <div>
                    <h4 class="section-title text-lg">Datos Institución</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">                      

                        <div class="flex-with-button">
                            <div class="flex-grow">
                                <label for="edit-caller-institution" class="block text-sm font-medium text-gray-700">Institución</label>
                                <select id="edit-caller-institution" name="institucion" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" required></select>
                            </div>
                            <button type="button" id="add-institution-edit-btn" class="ml-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"><i class="fa-solid fa-plus"></i></button>
                        </div>

                        <div><label for="edit-call-area" class="block text-sm font-medium text-gray-700">Área</label><textarea id="edit-call-area" name="area" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" required></textarea></div>
                        <div><label for="edit-call-subject" class="block text-sm font-medium text-gray-700">Asunto</label><input type="text" id="edit-call-subject" name="asunto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" required></div>
                        <div><label for="edit-call-query" class="block text-sm font-medium text-gray-700">Consulta</label><input type="text" id="edit-call-query" name="consulta" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" required></div>
                    </div>
                </div>
                <div>
                    <h4 class="section-title text-lg">Datos Personales</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label for="edit-caller-name" class="block text-sm font-medium text-gray-700">Nombre</label><input type="text" id="edit-caller-name" name="nombre" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" required></div>
                        <div><label for="edit-caller-cargo" class="block text-sm font-medium text-gray-700">Cargo</label><input type="text" id="edit-caller-cargo" name="cargo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" required></div>
                        <div><label for="edit-caller-email" class="block text-sm font-medium text-gray-700">Correo</label><input type="email" id="edit-caller-email" name="correo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" required></div>
                        <div>
                          <label for="edit-caller-phone" class="block text-sm font-medium text-gray-700">Teléfono (opcional)</label>
                          <input type="text" id="edit-caller-phone" name="telefono" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2">
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="section-title text-lg">Atendió y Comentarios</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="flex items-end">
                            <div class="flex-grow"><label for="edit-call-atendio" class="block text-sm font-medium text-gray-700">Atendió</label><select id="edit-call-atendio" name="atendio" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2" required></select></div>
                            <button type="button" id="add-atendio-edit-btn" class="ml-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <div><label for="edit-call-comments" class="block text-sm font-medium text-gray-700">Comentarios</label><input type="text" id="edit-call-comments" name="comentarios" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-gob-maroon focus:ring-gob-maroon sm:text-sm p-2"></div>
                    </div>
                </div>
                <div class="flex items-center justify-end pt-4"><button type="submit" class="bg-gob-maroon hover:bg-[#5a0025] text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar Cambios</button></div>
            </form>
        </div>
    </div>
    
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center"><h3 class="text-xl font-bold text-slate-800 mb-4">Confirmar Eliminación</h3><p class="text-slate-600 mb-6">¿Estás seguro de que deseas eliminar este registro?</p><div class="flex justify-center space-x-4"><button id="cancel-delete-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button><button id="confirm-delete-btn" class="bg-subtle-red hover:bg-subtle-red-dark text-white font-bold py-2 px-4 rounded-lg">Eliminar</button></div></div>
    </div>

    <div id="replace-historical-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center"><h3 class="text-xl font-bold text-gob-maroon mb-4">Reemplazar Histórico</h3><p class="text-slate-600 mb-6">¿Desea reemplazar el histórico actual?</p><div class="flex justify-center space-x-4"><button id="cancel-replace-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">No</button><button id="confirm-replace-btn" class="bg-gob-maroon hover:bg-[#5a0025] text-white font-bold py-2 px-4 rounded-lg">Sí</button></div></div>
    </div>


    <div id="add-atendio-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-gob-maroon mb-4">Agregar Nuevo Atendió</h3>
            <input type="text" id="new-atendio-input" placeholder="Ingrese el nuevo usuario" class="w-full p-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-center space-x-4"><button id="cancel-add-atendio-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button><button id="confirm-add-atendio-btn" class="bg-gob-maroon hover:bg-[#5a0025] text-white font-bold py-2 px-4 rounded-lg">Agregar</button></div>
        </div>
    </div>


    <div id="add-institution-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-gob-maroon mb-4">Agregar Nueva Institución</h3>
            <input type="text" id="new-institution-input" placeholder="Ingrese la nueva institución" class="w-full p-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-center space-x-4">
                <button id="cancel-add-institution-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-add-institution-btn" class="bg-gob-maroon hover:bg-[#5a0025] text-white font-bold py-2 px-4 rounded-lg">Agregar</button>
            </div>
        </div>
    </div>



    <script type="module">
        // INICIALIZACIÓN DE FIREBASE (v3.3 final)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBdiTQPTIklfTx4W4_cWn4wule50FKXknY",
            authDomain: "llamadasicoin.firebaseapp.com",
            projectId: "llamadasicoin",
            storageBucket: "llamadasicoin.appspot.com",
            messagingSenderId: "689552307207",
            appId: "1:689552307207:web:a18fdf88cdf2583fa466a2",
            measurementId: "G-Z97PD6VZR4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // LÓGICA DE LA APLICACIÓN (v3.3 final)

        let timerInterval;
        let callStartTime;
        let calls = [];
        let historicalCalls = [];
        let areas = ['Sistemas', 'Recursos Humanos', 'Finanzas']; // Valores por defecto
        let institutions = ['GEM', 'ISSEMYM', 'Otro']; // Valores por defecto
        let atendioUsers = ['Usuario A', 'Usuario B', 'Usuario C']; // Valores por defecto
        let userId;
        
        const callsCollectionRef = collection(db, "calls");
        const historicalCallsCollectionRef = collection(db, "historicalCalls");
        const configDocRef = doc(db, "config", "options");
        
        const loader = document.getElementById('loader');
        const appContainer = document.getElementById('app');
        const userInfo = document.getElementById('user-info');
        const tabsContainer = document.getElementById('tabs');
        const tabContents = document.querySelectorAll('.tab-content');
        const dashboardDataSource = document.getElementById('dashboard-data-source');
        const totalCallsElem = document.getElementById('total-calls');
        const avgDurationElem = document.getElementById('avg-duration');
        const atendidasCountElem = document.getElementById('atendidas-count');
        const pendientesCountElem = document.getElementById('pendientes-count');
        const timerElem = document.getElementById('timer');
        const startCallBtn = document.getElementById('start-call-btn');
        const downloadExcelBtn = document.getElementById('download-excel-btn');
        const callLogTableBody = document.getElementById('calls-table-body');
        const noCallsMessage = document.getElementById('no-calls-message');
        const historicalTableBody = document.getElementById('historical-table-body');
        const noHistoricalMessage = document.getElementById('no-historical-message');
        const historicalFileInput = document.getElementById('historical-file-input');
        const historicalFileName = document.getElementById('file-name');
        const importHistoricalBtn = document.getElementById('import-historical-btn');
        const reportesDataSource = document.getElementById('reportes-data-source');
        const statusChartCanvas = document.getElementById('statusChart');
        const areaChartCanvas = document.getElementById('areaChart');
        const dayOfWeekChartCanvas = document.getElementById('dayOfWeekChart');
        const institutionChartCanvas = document.getElementById('institutionChart');
        let statusChart, areaChart, dayOfWeekChart, institutionChart;
        const callModal = document.getElementById('call-modal');
        const callForm = document.getElementById('call-form');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const modalTimerElem = document.getElementById('modal-timer');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const pivotTableContainer = document.getElementById('pivot-table');
        const addAtendioBtn = document.getElementById('add-atendio-btn');
        const addAtendioEditBtn = document.getElementById('add-atendio-edit-btn');
        const replaceHistoricalModal = document.getElementById('replace-historical-modal');
        const cancelReplaceBtn = document.getElementById('cancel-replace-btn');
        const confirmReplaceBtn = document.getElementById('confirm-replace-btn');
        const addAtendioModal = document.getElementById('add-atendio-modal');
        const newAtendioInput = document.getElementById('new-atendio-input');
        const cancelAddAtendioBtn = document.getElementById('cancel-add-atendio-btn');
        const confirmAddAtendioBtn = document.getElementById('confirm-add-atendio-btn');
        let currentEditIsHistorical = false;
        
        function showApp() {
            loader.classList.add('hidden');
            appContainer.classList.remove('hidden');
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.createElement('div');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-gray-500' };
            alertContainer.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white transform transition-all duration-300 z-[60] ${colors[type]}`;
            alertContainer.textContent = message;
            document.body.appendChild(alertContainer);
            setTimeout(() => { alertContainer.remove(); }, 3000);
        }
        
        function setupTabs() {
            tabsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    const tabName = e.target.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `tab-content-${tabName}`));
                    if (tabName === 'reportes') updateCharts();
                }
            });
        }

        function updateDashboard() {
            const source = dashboardDataSource.value;
            let data = [];
            if (source === 'registro') data = calls;
            else if (source === 'historico') data = historicalCalls;
            else data = [...calls, ...historicalCalls];
            
            const totalCalls = data.length;
            const atendidas = data.filter(c => c.estatus === 'Atendida').length;
            const pendientes = totalCalls - atendidas;

            // Convertir duraciones a número y sumarlas
            const totalDuration = data.reduce((sum, c) => sum + (Number(c.duracion) || 0), 0);

            // Promedio redondeado a segundos enteros
            const avgDuration = totalCalls > 0 ? Math.round(totalDuration / totalCalls) : 0;

            // Actualizar UI
            totalCallsElem.textContent = totalCalls;
            avgDurationElem.textContent = formatDuration(avgDuration); // ya no usamos substring
            atendidasCountElem.textContent = atendidas;
            pendientesCountElem.textContent = pendientes;
        }

        function formatDuration(seconds) {
            if (isNaN(seconds) || seconds < 0) seconds = 0;
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }



        
        function renderTable(tableBody, data, isHistorical = false) {
            const noDataMessage = isHistorical ? noHistoricalMessage : noCallsMessage;
            tableBody.innerHTML = '';
            noDataMessage.classList.toggle('hidden', data.length > 0);

            const headers = ['no', 'fecha', 'inicio', 'fin', 'duracion', 'area', 'institucion', 'asunto', 'consulta', 'nombre', 'cargo', 'correo', 'telefono', 'estatus', 'atendio', 'comentarios'];

            data.forEach((call, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                
                let cells = headers.map(header => {
                    let content = '';
                    if (header === 'no') content = index + 1;
                    else if (header === 'duracion') content = formatDuration(call.duracion);
                    else if (header === 'estatus') {
                        content = `<button data-id="${call.id}" class="status-button status-${call.estatus === 'Atendida' ? 'atendida' : 'pendiente'} toggle-status-btn" data-is-historical="${isHistorical}">${call.estatus || 'Pendiente'}</button>`;
                    } else {
                        content = call[header] || 'N/A';
                    }
                    return `<td class="py-4 px-6">${content}</td>`;
                }).join('');

                const actionsCell = `<td class="py-4 px-6 flex space-x-2">
                        <button data-id="${call.id}" data-is-historical="${isHistorical}" class="edit-btn text-blue-500 hover:text-blue-700"><i class="fa-solid fa-edit"></i></button>
                        <button data-id="${call.id}" data-is-historical="${isHistorical}" class="delete-btn text-red-500 hover:text-red-700"><i class="fa-solid fa-trash-alt"></i></button>
                    </td>`;
                
                row.innerHTML = cells + actionsCell;
                tableBody.appendChild(row);
            });
        }
        
        function setupSorting(headerId, tableBody, dataProvider, renderFunc) {
            document.getElementById(headerId).addEventListener('click', (e) => {
                const header = e.target.closest('.sortable-header');
                if (!header) return;
                
                const sortBy = header.dataset.sortBy;
                let sortOrder = header.dataset.sortOrder === 'asc' ? 'desc' : 'asc';

                document.querySelectorAll(`#${headerId} .sortable-header`).forEach(h => {
                    h.dataset.sortOrder = ''; h.classList.remove('asc', 'desc');
                });
                header.dataset.sortOrder = sortOrder; header.classList.add(sortOrder);
                
                const data = dataProvider();
                const sortedData = [...data].sort((a, b) => {
                    const valA = a[sortBy] || ''; const valB = b[sortBy] || '';
                    const comparison = typeof valA === 'string' ? valA.localeCompare(valB, 'es', { numeric: true }) : valA - valB;
                    return sortOrder === 'asc' ? comparison : -comparison;
                });
                renderFunc(tableBody, sortedData, headerId.includes('historical'));
            });
        }
        
        function setupFiltering(inputId, tableBody, dataProvider, renderFunc, isHistorical = false) {
            const filterInput = document.getElementById(inputId);
            const clearFilterBtn = document.getElementById(`clear-filter-btn-${inputId.split('-')[2]}`);
            filterInput.addEventListener('input', () => {
                const filterText = filterInput.value.toLowerCase();
                clearFilterBtn.classList.toggle('hidden', !filterText);
                const data = dataProvider();
                const filteredData = data.filter(call => Object.values(call).some(value => String(value).toLowerCase().includes(filterText)));
                renderFunc(tableBody, filteredData, isHistorical);
            });
            clearFilterBtn.addEventListener('click', () => {
                filterInput.value = ''; filterInput.dispatchEvent(new Event('input'));
            });
        }

        async function initializeAppWithAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userInfo.textContent = `Usuario Anónimo: ${userId.substring(0, 8)}...`;
                    setupRealtimeListeners();
                    await loadConfigOptions();
                    showApp();
                } else {
                    await signInAnonymously(auth);
                }
            });
        }
        
        function setupRealtimeListeners() {
            onSnapshot(query(callsCollectionRef), (snapshot) => {
                calls = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortAndRenderTable(callLogTableBody, calls, false);
                updateDashboard();
                updateCharts();
                updateAutocompletes();
            }, (error) => {
                console.error("Error en listener de llamadas:", error);
                showAlert(`Error al cargar datos en tiempo real: ${error.message}`, "error");
            });
            
            onSnapshot(query(historicalCallsCollectionRef), (snapshot) => {
                historicalCalls = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortAndRenderTable(historicalTableBody, historicalCalls, true);
                updateDashboard();
                updateCharts();
                updateAutocompletes();
            }, (error) => {
                console.error("Error en listener de histórico:", error);
                showAlert(`Error al cargar datos históricos: ${error.message}`, "error");
            });
        }

        function sortAndRenderTable(tableBody, data, isHistorical) {
            const sortedData = [...data].sort((a, b) => {
                const dateA = new Date(a.fecha?.split('/').reverse().join('-'));
                const dateB = new Date(b.fecha?.split('/').reverse().join('-'));
                if (isNaN(dateA)) return 1; // Mueve fechas inválidas/faltantes al final
                if (isNaN(dateB)) return -1;
                return dateB - dateA; // Descendente
            });
            renderTable(tableBody, sortedData, isHistorical);
        }

        async function loadConfigOptions() {
            try {
                const docSnap = await getDoc(configDocRef);
                if (docSnap.exists()) {
                    const config = docSnap.data();
                    areas = config.areas || areas;
                    institutions = config.institutions || institutions;
                    atendioUsers = config.atendioUsers || atendioUsers;
                } else {
                    await setDoc(configDocRef, { areas, institutions, atendioUsers });
                }
            } catch (error) {
                console.error("Error cargando configuración, se usarán valores por defecto:", error);
                showAlert("No se pudo cargar la configuración de opciones.", "warning");
            } finally {
                populateAllSelects();
            }
        }
        

        // Agregar nuevo Atendio
        async function addNewAtendio(newUser) {
            if (!newUser) return;
            if (!atendioUsers.includes(newUser)) {
                atendioUsers.push(newUser);
                await setDoc(configDocRef, { atendioUsers }, { merge: true });
                populateAllSelects();
            }
        }



        // Agregar nueva institución
        async function addNewInstitution(newInstitution) {
            if (!newInstitution) return;
            if (!institutions.includes(newInstitution)) {
                institutions.push(newInstitution);
                await setDoc(configDocRef, { institutions }, { merge: true });
                populateAllSelects();
            }
        }


        function populateAllSelects() {
            populateSelect(document.getElementById('call-atendio'), atendioUsers.sort());
            populateSelect(document.getElementById('edit-call-atendio'), atendioUsers.sort());
            
            // Inicializar Select2 para los campos de institución
            $('#caller-institution').select2({ 
                data: institutions.sort(), 
                tags: true, 
                placeholder: "Seleccione o busque una institución", 
                allowClear: true 
            });
            
            $('#edit-caller-institution').select2({ 
                data: institutions.sort(), 
                tags: true, 
                placeholder: "Seleccione o busque una institución", 
                allowClear: true 
            });
        }


        function populateSelect(selectElement, options) {
            if (!selectElement) return;
            selectElement.innerHTML = '<option value="">Seleccione una opción</option>';
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
        }


        // MODIFICACIÓN: Actualizar función updateAutocompletes
        function updateAutocompletes() {
            const allData = [...calls, ...historicalCalls]; 

            const uniqueAreas = [...new Set(allData.map(c => c.area).filter(Boolean))];
            const uniqueInstitutions = [...new Set(allData.map(c => c.institucion).filter(Boolean))];
            const uniqueNombres = [...new Set(allData.map(c => c.nombre).filter(Boolean))];
            const uniqueCargos = [...new Set(allData.map(c => c.cargo).filter(Boolean))];
            const uniqueCorreos = [...new Set(allData.map(c => c.correo).filter(Boolean))];
            const uniqueTelefonos = [...new Set(allData.map(c => c.telefono).filter(Boolean))];
            const uniqueAsuntos = [...new Set(allData.map(c => c.asunto).filter(Boolean))];
            const uniqueConsultas = [...new Set(allData.map(c => c.consulta).filter(Boolean))];
            const uniqueComentarios = [...new Set(allData.map(c => c.comentarios).filter(Boolean))];
            const uniqueAtendios = [...new Set(allData.map(c => c.atendio).filter(Boolean))];

            // Para formulario de nueva llamada 
            $("#call-area").autocomplete({ source: uniqueAreas });
            $("#caller-name").autocomplete({ source: uniqueNombres });
            $("#caller-cargo").autocomplete({ source: uniqueCargos });
            $("#caller-email").autocomplete({ source: uniqueCorreos });
            $("#caller-phone").autocomplete({ source: uniqueTelefonos, classes: {"ui-autocomplete": "bg-white border border-gray-300 rounded-md shadow-lg"}});
            $("#call-subject").autocomplete({ source: uniqueAsuntos });
            $("#call-query").autocomplete({ source: uniqueConsultas });
            $("#call-comments").autocomplete({ source: uniqueComentarios });

            // Para formulario de edición
            $("#edit-call-area").autocomplete({ source: uniqueAreas });
            $("#edit-caller-name").autocomplete({ source: uniqueNombres });
            $("#edit-caller-cargo").autocomplete({ source: uniqueCargos });
            $("#edit-caller-email").autocomplete({ source: uniqueCorreos });
            $("#edit-caller-phone").autocomplete({source: uniqueTelefonos, classes: {"ui-autocomplete": "bg-white border border-gray-300 rounded-md shadow-lg"} });
            $("#edit-call-subject").autocomplete({ source: uniqueAsuntos });
            $("#edit-call-query").autocomplete({ source: uniqueConsultas });
            $("#edit-call-comments").autocomplete({ source: uniqueComentarios });

            // NUEVO: Actualizar lista de atendió con valores históricos
            const newAtendios = uniqueAtendios.filter(a => !atendioUsers.includes(a));
            if (newAtendios.length > 0) {
                atendioUsers = [...atendioUsers, ...newAtendios];
                setDoc(configDocRef, { atendioUsers }, { merge: true });
                populateSelect(document.getElementById('call-atendio'), atendioUsers.sort());
                populateSelect(document.getElementById('edit-call-atendio'), atendioUsers.sort());
            }

            // Aplicar Select2 a institución para búsqueda
            $('#caller-institution').select2({ data: uniqueInstitutions.sort(), tags: true, placeholder: "Seleccione o busque una institución", allowClear: true });
            $('#edit-caller-institution').select2({ data: uniqueInstitutions.sort(), tags: true, placeholder: "Seleccione o busque una institución", allowClear: true });
        }


        async function saveCall(callData) {
            try {
                await addDoc(callsCollectionRef, { ...callData, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
                showAlert("Llamada guardada con éxito!", "success");
            } catch (error) {
                console.error("Error al guardar la llamada:", error);
                showAlert(`Error al guardar: ${error.message}`, "error");
            }
        }
        
        async function updateCall(id, updateData, isHistorical) {
            try {
                const collectionRef = isHistorical ? historicalCallsCollectionRef : callsCollectionRef;
                const callDocRef = doc(db, collectionRef.path, id);
                await updateDoc(callDocRef, { ...updateData, updatedAt: serverTimestamp() });
                showAlert("Llamada actualizada con éxito!", "success");
            } catch (error) {
                console.error("Error al actualizar la llamada:", error);
                showAlert(`Error al actualizar: ${error.message}`, "error");
            }
        }
        
        async function deleteCall(id, isHistorical) {
            try {
                const collectionRef = isHistorical ? historicalCallsCollectionRef : callsCollectionRef;
                const callDocRef = doc(db, collectionRef.path, id);
                await deleteDoc(callDocRef);
                showAlert("Llamada eliminada con éxito!", "success");
            } catch (error) {
                console.error("Error al eliminar la llamada:", error);
                showAlert(`Error al eliminar: ${error.message}`, "error");
            }
        }

        async function deleteAllHistorical() {
            const batch = writeBatch(db);
            historicalCalls.forEach(call => {
                const ref = doc(historicalCallsCollectionRef, call.id);
                batch.delete(ref);
            });
            await batch.commit();
        }

        async function importHistoricalData(data) {
            try {
                const batch = writeBatch(db);
                data.forEach(item => {
                    const docRef = doc(historicalCallsCollectionRef);
                    batch.set(docRef, { ...item, importedAt: serverTimestamp() });
                });
                await batch.commit();
                showAlert(`Se han importado ${data.length} registros históricos.`, "success");
            } catch (error) {
                console.error("Error al importar datos históricos:", error);
                showAlert(`Error al importar: ${error.message}`, "error");
            }
        }
        
        function updateCharts() {
            const source = reportesDataSource.value;
            let data = [];
            if (source === 'registro') data = calls;
            else if (source === 'historico') data = historicalCalls;
            else data = [...calls, ...historicalCalls];
            
            if (data.length === 0) return;
            
            const statusCounts = {}, areaCounts = {}, dayOfWeekCounts = {}, institutionCounts = {};
            data.forEach(call => {
                statusCounts[call.estatus] = (statusCounts[call.estatus] || 0) + 1;
                areaCounts[call.area] = (areaCounts[call.area] || 0) + 1;
                institutionCounts[call.institucion] = (institutionCounts[call.institucion] || 0) + 1;
                if (call.fecha && typeof call.fecha === 'string') {
                    try {
                        const date = new Date(call.fecha.split('/').reverse().join('-'));
                        const day = date.toLocaleDateString('es-ES', { weekday: 'long' });
                        dayOfWeekCounts[day] = (dayOfWeekCounts[day] || 0) + 1;
                    } catch (e) { /* Ignorar fechas inválidas */ }
                }
            });
            
            const createOrUpdateChart = (canvas, chartInstance, type, data, labelsOrder) => {
                if (chartInstance) chartInstance.destroy();
                let labels = Object.keys(data);
                if (labelsOrder) labels.sort((a, b) => labelsOrder.indexOf(a) - labelsOrder.indexOf(b));
                const chartData = labels.map(label => data[label]);
                return new Chart(canvas, { type, data: { labels, datasets: [{ data: chartData, backgroundColor: ['#6A002C', '#10B981', '#EF4444', '#FCD34D', '#3B82F6'] }] }, options: { responsive: true } });
            };

            statusChart = createOrUpdateChart(statusChartCanvas, statusChart, 'pie', statusCounts);
            areaChart = createOrUpdateChart(areaChartCanvas, areaChart, 'bar', areaCounts);
            institutionChart = createOrUpdateChart(institutionChartCanvas, institutionChart, 'polarArea', institutionCounts);
            dayOfWeekChart = createOrUpdateChart(dayOfWeekChartCanvas, dayOfWeekChart, 'line', dayOfWeekCounts, ['lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado', 'domingo']);

            // Locale en español para PivotTable.js
            $.pivotUtilities.locales.es = {
                localeStrings: {
                    renderError: "Error al renderizar los resultados.",
                    computeError: "Error al calcular los resultados.",
                    uiRenderError: "Error al renderizar la interfaz.",
                    selectAll: "Seleccionar Todo",
                    selectNone: "Seleccionar Ninguno",
                    tooMany: "(demasiados para listar)",
                    filterResults: "Filtrar resultados",
                    apply: "Aplicar",
                    cancel: "Cancelar",
                    totals: "Totales",
                    vs: "vs",
                    by: "por"
                },
                aggregators: {
                    "Count": "Conteo",
                    "Count Unique Values": "Conteo de Valores Únicos",
                    "List Unique Values": "Lista de Valores Únicos",
                    "Sum": "Suma",
                    "Integer Sum": "Suma Entera",
                    "Average": "Promedio",
                    "Median": "Mediana",
                    "Sample Variance": "Varianza Muestral",
                    "Sample Standard Deviation": "Desviación Estándar Muestral",
                    "Minimum": "Mínimo",
                    "Maximum": "Máximo",
                    "First": "Primero",
                    "Last": "Último",
                    "Sum over Sum": "Suma sobre Suma",
                    "80% Upper Bound": "Límite Superior 80%",
                    "80% Lower Bound": "Límite Inferior 80%",
                    "Sum as Fraction of Total": "Suma como Fracción del Total",
                    "Sum as Fraction of Rows": "Suma como Fracción de Filas",
                    "Sum as Fraction of Columns": "Suma como Fracción de Columnas",
                    "Count as Fraction of Total": "Conteo como Fracción del Total",
                    "Count as Fraction of Rows": "Conteo como Fracción de Filas",
                    "Count as Fraction of Columns": "Conteo como Fracción de Columnas"
                },
                renderers: {
                    "Table": "Tabla",
                    "Table Barchart": "Tabla con Gráfico de Barras",
                    "Heatmap": "Mapa de Calor",
                    "Row Heatmap": "Mapa de Calor por Fila",
                    "Col Heatmap": "Mapa de Calor por Columna",
                    "Line Chart": "Gráfico de Líneas",
                    "Bar Chart": "Gráfico de Barras",
                    "Stacked Bar Chart": "Gráfico de Barras Apiladas",
                    "Area Chart": "Gráfico de Área",
                    "Scatter Chart": "Gráfico de Dispersión",
                    "Multiple Pie Chart": "Gráfico de Pastel Múltiple",
                    "Treemap": "Mapa de Árbol"
                }
            };

            // Inicializar tabla dinámica con locale 'es'
            $(pivotTableContainer).pivotUI(data, {
                rows: ["area"],
                cols: ["estatus"],
                vals: ["duracion"],
                aggregatorName: "Conteo",
                rendererName: "Tabla",
                locale: "es"
            });
        }
        
        // MANEJO DE EVENTOS Y LÓGICA DE UI (v3.3 final)
        
        document.addEventListener('DOMContentLoaded', initializeAppWithAuth);
        
        setupTabs();
        setupSorting('main-table-header', callLogTableBody, () => calls, renderTable);
        setupSorting('historical-table-header', historicalTableBody, () => historicalCalls, renderTable);
        setupFiltering('filter-input-main', callLogTableBody, () => calls, renderTable, false);
        setupFiltering('filter-input-historical', historicalTableBody, () => historicalCalls, renderTable, true);
        
        dashboardDataSource.addEventListener('change', updateDashboard);
        reportesDataSource.addEventListener('change', updateCharts);
        
        startCallBtn.addEventListener('click', () => {
            if (startCallBtn.dataset.state === 'active') {
                stopTimer(false); 
                closeModal(callModal);
            } else {
                startTimer();
            }
        });
        
        function startTimer() {
            startCallBtn.dataset.state = 'active';
            startCallBtn.innerHTML = `<i class="fa-solid fa-stopwatch h-6 w-6"></i><span>Finalizar Llamada</span>`;
            startCallBtn.classList.replace('bg-subtle-green', 'bg-subtle-red');
            startCallBtn.classList.replace('hover:bg-subtle-green-dark', 'hover:bg-subtle-red-dark');
            
            callForm.reset();
            openModal(callModal);

            callStartTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                const formattedTime = formatDuration(elapsed);
                timerElem.textContent = formattedTime;
                modalTimerElem.textContent = formattedTime;
            }, 1000);
        }
        
        function stopTimer(shouldSave = true) {
            clearInterval(timerInterval);
            if (shouldSave) {
                const endTime = new Date();
                const duration = Math.floor((endTime - callStartTime) / 1000);
                const formData = new FormData(callForm);
                const callData = Object.fromEntries(formData.entries());
                
                callData.fecha = new Date(callStartTime).toLocaleDateString('es-ES');
                callData.inicio = new Date(callStartTime).toLocaleTimeString('es-ES', { hour12: false });
                callData.fin = endTime.toLocaleTimeString('es-ES', { hour12: false });
                callData.duracion = duration;
                callData.estatus = 'Atendida'; // Se asume atendida al guardar
                saveCall(callData);
            }
            
            startCallBtn.dataset.state = 'inactive';
            startCallBtn.innerHTML = `<i class="fa-solid fa-phone-alt h-6 w-6"></i><span>Iniciar Nueva Llamada</span>`;
            startCallBtn.classList.replace('bg-subtle-red', 'bg-subtle-green');
            startCallBtn.classList.replace('hover:bg-subtle-red-dark', 'hover:bg-subtle-green-dark');
            resetTimer();
        }




        function resetTimer() {
            timerElem.textContent = '00:00:00';
            modalTimerElem.textContent = '00:00:00';
        }
        
        function openModal(modal) {
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
        }

        function closeModal(modal) {
            modal.classList.remove('modal-enter');
            modal.classList.add('modal-leave');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        closeModalBtn.addEventListener('click', () => {
            closeModal(callModal);
            if (startCallBtn.dataset.state === 'active') stopTimer(false);
        });
        
        callForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!callForm.checkValidity()) {
                showAlert("Por favor, completa todos los campos requeridos.", "error");
                return;
            }
            stopTimer(true);
            closeModal(callModal);
        });

        function handleEditClick(e) {
            const callId = e.currentTarget.dataset.id;
            const isHistorical = e.currentTarget.dataset.isHistorical === 'true';
            currentEditIsHistorical = isHistorical;
            const allData = isHistorical ? historicalCalls : calls;
            const callToEdit = allData.find(call => call.id === callId);
            if (!callToEdit) return;

            // Llenar campos del formulario
            document.getElementById('edit-id').value = callId;
            document.getElementById('edit-call-area').value = callToEdit.area || '';
            document.getElementById('edit-call-subject').value = callToEdit.asunto || '';
            document.getElementById('edit-call-query').value = callToEdit.consulta || '';
            document.getElementById('edit-caller-name').value = callToEdit.nombre || '';
            document.getElementById('edit-caller-cargo').value = callToEdit.cargo || '';
            document.getElementById('edit-caller-email').value = callToEdit.correo || '';
            document.getElementById('edit-caller-phone').value = callToEdit.telefono || '';
            document.getElementById('edit-call-comments').value = callToEdit.comentarios || '';

            // Actualizar Select2 para institución y atendió
            $('#edit-caller-institution').val(callToEdit.institucion || '').trigger('change');
            $('#edit-call-atendio').val(callToEdit.atendio || '').trigger('change');

            openModal(editModal);
        }

        closeEditModalBtn.addEventListener('click', () => closeModal(editModal));

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!editForm.checkValidity()) {
                showAlert("Por favor, completa todos los campos requeridos.", "error");
                return;
            }
            
            const callId = editForm['edit-id'].value;
            const updateData = {
                area: document.getElementById('edit-call-area').value,
                asunto: document.getElementById('edit-call-subject').value,
                consulta: document.getElementById('edit-call-query').value,
                nombre: document.getElementById('edit-caller-name').value,
                cargo: document.getElementById('edit-caller-cargo').value,
                correo: document.getElementById('edit-caller-email').value,
                telefono: document.getElementById('edit-caller-phone').value,
                comentarios: document.getElementById('edit-call-comments').value,
                institucion: document.getElementById('edit-caller-institution').value,
                atendio: document.getElementById('edit-call-atendio').value
            };

            await updateCall(callId, updateData, currentEditIsHistorical);
            closeModal(editModal);
        });

        async function handleStatusToggle(e) {
            const button = e.currentTarget;
            const callId = button.dataset.id;
            const isHistorical = button.dataset.isHistorical === 'true';
            const currentStatus = button.textContent.trim();
            const newStatus = currentStatus === 'Atendida' ? 'Pendiente' : 'Atendida';
            await updateCall(callId, { estatus: newStatus }, isHistorical);
        }

        let callToDeleteId = null;
        let callToDeleteIsHistorical = false;
        function handleDeleteClick(e) {
            callToDeleteId = e.currentTarget.dataset.id;
            callToDeleteIsHistorical = e.currentTarget.dataset.isHistorical === 'true';
            openModal(confirmModal);
        }

        cancelDeleteBtn.addEventListener('click', () => {
            closeModal(confirmModal);
            callToDeleteId = null;
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (callToDeleteId) {
                await deleteCall(callToDeleteId, callToDeleteIsHistorical);
                closeModal(confirmModal);
            }
        });

        callLogTableBody.addEventListener('click', e => {
            const target = e.target.closest('button');
            if (!target) return;
            if (target.classList.contains('edit-btn')) handleEditClick({ currentTarget: target });
            if (target.classList.contains('delete-btn')) handleDeleteClick({ currentTarget: target });
            if (target.classList.contains('toggle-status-btn')) handleStatusToggle({ currentTarget: target });
        });
        historicalTableBody.addEventListener('click', e => {
            const target = e.target.closest('button');
            if (!target) return;
            if (target.classList.contains('edit-btn')) handleEditClick({ currentTarget: target });
            if (target.classList.contains('delete-btn')) handleDeleteClick({ currentTarget: target });
            if (target.classList.contains('toggle-status-btn')) handleStatusToggle({ currentTarget: target });
        });
        
        downloadExcelBtn.addEventListener('click', () => {
            if (calls.length === 0) return showAlert("No hay datos para descargar.", "warning");
            const ws = XLSX.utils.json_to_sheet(calls);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Llamadas");
            XLSX.writeFile(wb, "registro_llamadas.xlsx");
        });
        
        document.getElementById('download-historical-excel-btn').addEventListener('click', () => {
            if (historicalCalls.length === 0) return showAlert("No hay datos históricos para descargar.", "warning");
            const ws = XLSX.utils.json_to_sheet(historicalCalls);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Historico");
            XLSX.writeFile(wb, "registro_historico.xlsx");
        });

        historicalFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                historicalFileName.textContent = file.name;
                importHistoricalBtn.disabled = false;
            } else {
                historicalFileName.textContent = 'Seleccionar archivo Excel (.xlsx)';
                importHistoricalBtn.disabled = true;
            }
        });
        
        importHistoricalBtn.addEventListener('click', async () => {
            const file = historicalFileInput.files[0];
            if (!file) return showAlert("Por favor, selecciona un archivo Excel primero.", "warning");
            
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const workbook = XLSX.read(event.target.result, { type: 'binary', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);

                    const processedData = json.map(row => {
                        const mapKeys = (obj, keyMap) => Object.keys(obj).reduce((acc, key) => {
                            const newKey = keyMap[key.toLowerCase().trim()] || key.toLowerCase().trim();
                            acc[newKey] = obj[key];
                            return acc;
                        }, {});

                        const keyMapping = { 'no.': 'no', 'duración': 'duracion', 'área': 'area', 'institución': 'institucion', 'teléfono': 'telefono', 'atendió': 'atendio' };
                        const mappedRow = mapKeys(row, keyMapping);

                        const fechaDate = mappedRow.fecha instanceof Date ? mappedRow.fecha : new Date();
                        const inicioDate = mappedRow.inicio instanceof Date ? mappedRow.inicio : new Date();
                        const finDate = mappedRow.fin instanceof Date ? mappedRow.fin : new Date();

                        return {
                            fecha: fechaDate.toLocaleDateString('es-ES'),
                            inicio: inicioDate.toLocaleTimeString('es-ES', { hour12: false }),
                            fin: finDate.toLocaleTimeString('es-ES', { hour12: false }),
                            duracion: typeof mappedRow.duracion === 'number' && mappedRow.duracion < 1 ? Math.round(mappedRow.duracion * 86400) : (mappedRow.duracion || 0),
                            area: mappedRow.area || 'N/A',
                            institucion: mappedRow.institucion || 'N/A',
                            asunto: mappedRow.asunto || 'N/A',
                            consulta: mappedRow.consulta || 'N/A',
                            nombre: mappedRow.nombre || 'N/A',
                            cargo: mappedRow.cargo || 'N/A',
                            correo: mappedRow.correo || 'N/A',
                            telefono: String(mappedRow.telefono || 'N/A'),
                            estatus: mappedRow.estatus || 'Pendiente',
                            atendio: mappedRow.atendio || 'N/A',
                            comentarios: mappedRow.comentarios || ''
                        };
                    });

                    if (processedData.length === 0) return showAlert("El archivo Excel está vacío o no es válido.", "warning");
                    
                    let replace = false;
                    if (historicalCalls.length > 0) {
                        openModal(replaceHistoricalModal);
                        await new Promise(resolve => {
                            confirmReplaceBtn.onclick = () => {
                                replace = true;
                                closeModal(replaceHistoricalModal);
                                resolve();
                            };
                            cancelReplaceBtn.onclick = () => {
                                replace = false;
                                closeModal(replaceHistoricalModal);
                                resolve();
                            };
                        });
                        if (replace) {
                            await deleteAllHistorical();
                        }
                    }
                    await importHistoricalData(processedData);
                    historicalFileInput.value = '';
                    historicalFileName.textContent = 'Seleccionar archivo Excel (.xlsx)';
                    importHistoricalBtn.disabled = true;
                } catch (error) {
                    console.error("Error al procesar el archivo Excel:", error);
                    showAlert(`Error al procesar el archivo: ${error.message}`, "error");
                }
            };
            reader.readAsBinaryString(file);
        });


        // Eventos nueva institucion
        document.getElementById('add-institution-btn')?.addEventListener('click', () => {
            openModal(document.getElementById('add-institution-modal'));
        });

        document.getElementById('add-institution-edit-btn')?.addEventListener('click', () => {
            openModal(document.getElementById('add-institution-modal'));
        });

        // Evento para agregar nueva institución
        document.getElementById('confirm-add-institution-btn')?.addEventListener('click', () => {
            const newInstitution = document.getElementById('new-institution-input').value.trim();
            if (newInstitution) {
                addNewInstitution(newInstitution);
                
                // Actualizar los selects de institución
                $('#caller-institution').append(new Option(newInstitution, newInstitution)).trigger('change');
                $('#edit-caller-institution').append(new Option(newInstitution, newInstitution)).trigger('change');
            }
            closeModal(document.getElementById('add-institution-modal'));
            document.getElementById('new-institution-input').value = '';
        });



        // EVENTOS del boton "Atendio"

        addAtendioBtn.addEventListener('click', () => {
            openModal(addAtendioModal);
        });

        addAtendioEditBtn.addEventListener('click', () => {
            openModal(addAtendioModal);
        });

        cancelAddAtendioBtn.addEventListener('click', () => {
            closeModal(addAtendioModal);
            newAtendioInput.value = '';
        });

        confirmAddAtendioBtn.addEventListener('click', () => {
            const newUser = newAtendioInput.value.trim();
            if (newUser) {
                addNewAtendio(newUser);
            }
            closeModal(addAtendioModal);
            newAtendioInput.value = '';
        });

        // Añadir este evento para el botón de cancelar
        document.getElementById('cancel-add-institution-btn')?.addEventListener('click', () => {
            closeModal(document.getElementById('add-institution-modal'));
            document.getElementById('new-institution-input').value = '';
        });




        // Asegurar que los modales se cierren correctamente
        [closeModalBtn, closeEditModalBtn, cancelDeleteBtn].forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[id$="-modal"]').forEach(modal => {
                    modal.classList.add('hidden');
                });
            });
        });


    </script>
</body>
</html> 
